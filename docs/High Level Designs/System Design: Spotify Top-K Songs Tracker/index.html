<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-High Level Designs/System Design: Spotify Top-K Songs Tracker" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.5.2">
<title data-rh="true">System Design: Spotify Top-K Songs Tracker | DevEnigma</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://carefree-ladka.in/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://carefree-ladka.in/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://carefree-ladka.in/docs/High Level Designs/System Design: Spotify Top-K Songs Tracker"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="System Design: Spotify Top-K Songs Tracker | DevEnigma"><meta data-rh="true" name="description" content="Problem Statement"><meta data-rh="true" property="og:description" content="Problem Statement"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://carefree-ladka.in/docs/High Level Designs/System Design: Spotify Top-K Songs Tracker"><link data-rh="true" rel="alternate" href="https://carefree-ladka.in/docs/High Level Designs/System Design: Spotify Top-K Songs Tracker" hreflang="en"><link data-rh="true" rel="alternate" href="https://carefree-ladka.in/docs/High Level Designs/System Design: Spotify Top-K Songs Tracker" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="DevEnigma RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="DevEnigma Atom Feed"><link rel="stylesheet" href="/assets/css/styles.739955cc.css">
<script src="/assets/js/runtime~main.a46a2fdd.js" defer="defer"></script>
<script src="/assets/js/main.58d40509.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();null!==e?t(e):window.matchMedia("(prefers-color-scheme: dark)").matches?t("dark"):(window.matchMedia("(prefers-color-scheme: light)").matches,t("light"))}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="DevEnigma Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo.svg" alt="DevEnigma Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">DevEnigma</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/intro">Learning</a><a class="navbar__item navbar__link" href="/interviews">Interview Experiences</a><a class="navbar__item navbar__link" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://www.linkedin.com/in/kumpawan/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">LinkedIn<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/intro">DevEnigma | Learn &amp; Practice</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/college-revision">College Revision</a><button aria-label="Expand sidebar category &#x27;College Revision&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/operating-system">Operating System</a><button aria-label="Expand sidebar category &#x27;Operating System&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/web-development">Web Development</a><button aria-label="Expand sidebar category &#x27;Web Development&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/data-structures--algorithms">Data Structures &amp; Algorithms</a><button aria-label="Expand sidebar category &#x27;Data Structures &amp; Algorithms&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/java-tutorial">Java Tutorial</a><button aria-label="Expand sidebar category &#x27;Java Tutorial&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/company-specific">Company Specific</a><button aria-label="Expand sidebar category &#x27;Company Specific&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/java-multithreading-">Java Multithreading </a><button aria-label="Expand sidebar category &#x27;Java Multithreading &#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/tips--tricks">Tips &amp; Tricks</a><button aria-label="Expand sidebar category &#x27;Tips &amp; Tricks&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/backend-system-design">Backend System Design</a><button aria-label="Expand sidebar category &#x27;Backend System Design&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/node--expressjs">Node &amp; Express.js</a><button aria-label="Expand sidebar category &#x27;Node &amp; Express.js&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/database">Database</a><button aria-label="Expand sidebar category &#x27;Database&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/frontend-system-design">Frontend System Design</a><button aria-label="Expand sidebar category &#x27;Frontend System Design&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/low-level-design">Low Level Design</a><button aria-label="Expand sidebar category &#x27;Low Level Design&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" href="/docs/category/high-level-designs">High Level Designs</a><button aria-label="Collapse sidebar category &#x27;High Level Designs&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/High Level Designs/Rideshare Apps Architecture">Uber/Ola Rideshare Apps Architecture 🚗</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/High Level Designs/Social Media Platforms - HLD Architecture">Social Media Platforms - HLD Architecture 📱</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/High Level Designs/Social Media Timeline Design - HLD Architecture">Social Media Timeline Design - HLD Architecture  📰</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/High Level Designs/System Design: Spotify Top-K Songs Tracker">System Design: Spotify Top-K Songs Tracker</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/High Level Designs/System Design: Top-K YouTube Videos">System Design: Top-K YouTube Videos</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/High Level Designs/Video Streaming">Video Streaming at Scale 🎥</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/system-design">System Design</a><button aria-label="Expand sidebar category &#x27;System Design&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/data-science">Data Science</a><button aria-label="Expand sidebar category &#x27;Data Science&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/java-interview-guide">Java Interview Guide</a><button aria-label="Expand sidebar category &#x27;Java Interview Guide&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/redis">Redis</a><button aria-label="Expand sidebar category &#x27;Redis&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/complete-system-design-interview-guide--2025">Complete System Design Interview Guide — 2025</a><button aria-label="Expand sidebar category &#x27;Complete System Design Interview Guide — 2025&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/spring-boot">Spring Boot</a><button aria-label="Expand sidebar category &#x27;Spring Boot&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/category/high-level-designs"><span itemprop="name">High Level Designs</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">System Design: Spotify Top-K Songs Tracker</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>System Design: Spotify Top-K Songs Tracker</h1></header>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="problem-statement">Problem Statement<a href="#problem-statement" class="hash-link" aria-label="Direct link to Problem Statement" title="Direct link to Problem Statement">​</a></h2>
<p>Design a system that tracks and retrieves the top-K most played songs on Spotify in real-time, handling millions of song plays per second with minimal memory footprint.</p>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="requirements">Requirements<a href="#requirements" class="hash-link" aria-label="Direct link to Requirements" title="Direct link to Requirements">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="functional-requirements">Functional Requirements<a href="#functional-requirements" class="hash-link" aria-label="Direct link to Functional Requirements" title="Direct link to Functional Requirements">​</a></h3>
<ul>
<li>Track song play counts in real-time</li>
<li>Retrieve top-K most played songs (e.g., top 100)</li>
<li>Handle massive data streams (millions of plays/second)</li>
<li>Memory-efficient (sublinear in number of songs)</li>
<li>Near real-time accuracy (small error acceptable)</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="non-functional-requirements">Non-Functional Requirements<a href="#non-functional-requirements" class="hash-link" aria-label="Direct link to Non-Functional Requirements" title="Direct link to Non-Functional Requirements">​</a></h3>
<ul>
<li><strong>High Throughput</strong>: Process millions of events/second</li>
<li><strong>Low Latency</strong>: &lt; 100ms for Top-K queries</li>
<li><strong>Horizontally Scalable</strong>: Add nodes to handle load</li>
<li><strong>Fault Tolerant</strong>: No single point of failure</li>
<li><strong>Approximate Counts</strong>: Trade accuracy for efficiency (±ε error acceptable)</li>
</ul>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="high-level-architecture">High-Level Architecture<a href="#high-level-architecture" class="hash-link" aria-label="Direct link to High-Level Architecture" title="Direct link to High-Level Architecture">​</a></h2>
<!-- -->
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="core-components">Core Components<a href="#core-components" class="hash-link" aria-label="Direct link to Core Components" title="Direct link to Core Components">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="1-event-stream-apache-kafka">1. Event Stream (Apache Kafka)<a href="#1-event-stream-apache-kafka" class="hash-link" aria-label="Direct link to 1. Event Stream (Apache Kafka)" title="Direct link to 1. Event Stream (Apache Kafka)">​</a></h3>
<p><strong>Purpose</strong>: Ingest and buffer millions of play events</p>
<p><strong>Design Decisions</strong>:</p>
<ul>
<li><strong>Topics</strong>: <code>song-plays</code> topic with multiple partitions</li>
<li><strong>Partitioning Strategy</strong>: Hash by <code>songId</code> for even distribution</li>
<li><strong>Replication Factor</strong>: 3 for fault tolerance</li>
<li><strong>Retention</strong>: 7 days for replay capability</li>
</ul>
<p><strong>Benefits</strong>:</p>
<ul>
<li>Decouples producers from consumers</li>
<li>Handles traffic spikes via buffering</li>
<li>Enables multiple consumers for different analytics</li>
</ul>
<hr>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="2-stream-processing-layer-apache-flink">2. Stream Processing Layer (Apache Flink)<a href="#2-stream-processing-layer-apache-flink" class="hash-link" aria-label="Direct link to 2. Stream Processing Layer (Apache Flink)" title="Direct link to 2. Stream Processing Layer (Apache Flink)">​</a></h3>
<p><strong>Purpose</strong>: Process events in real-time and maintain data structures</p>
<p><strong>Processing Logic</strong>:</p>
<div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token maybe-class-name">For</span><span class="token plain"> each event</span><span class="token operator">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token number">1.</span><span class="token plain"> </span><span class="token maybe-class-name">Parse</span><span class="token plain"> songId </span><span class="token keyword module" style="color:rgb(189, 147, 249);font-style:italic">from</span><span class="token plain"> event</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token number">2.</span><span class="token plain"> </span><span class="token maybe-class-name">Update</span><span class="token plain"> </span><span class="token maybe-class-name">Count</span><span class="token operator">-</span><span class="token maybe-class-name">Min</span><span class="token plain"> </span><span class="token maybe-class-name">Sketch</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token number">3.</span><span class="token plain"> </span><span class="token maybe-class-name">Get</span><span class="token plain"> estimated count </span><span class="token keyword module" style="color:rgb(189, 147, 249);font-style:italic">from</span><span class="token plain"> </span><span class="token constant" style="color:rgb(189, 147, 249)">CMS</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token number">4.</span><span class="token plain"> </span><span class="token maybe-class-name">Update</span><span class="token plain"> </span><span class="token maybe-class-name">Top</span><span class="token operator">-</span><span class="token constant" style="color:rgb(189, 147, 249)">K</span><span class="token plain"> heap </span><span class="token keyword control-flow" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> needed</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token number">5.</span><span class="token plain"> </span><span class="token maybe-class-name">Periodically</span><span class="token plain"> flush to storage</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>Parallelism</strong>:</p>
<ul>
<li>Multiple Flink workers process different Kafka partitions</li>
<li>Each worker maintains local CMS + TopK</li>
<li>Periodic merge of local structures</li>
</ul>
<p><strong>State Management</strong>:</p>
<ul>
<li>Checkpointing enabled (every 1 minute)</li>
<li>State stored in RocksDB for fault tolerance</li>
</ul>
<hr>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="3-count-min-sketch-cms">3. Count-Min Sketch (CMS)<a href="#3-count-min-sketch-cms" class="hash-link" aria-label="Direct link to 3. Count-Min Sketch (CMS)" title="Direct link to 3. Count-Min Sketch (CMS)">​</a></h3>
<p><strong>Purpose</strong>: Space-efficient approximate frequency counter</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="structure">Structure<a href="#structure" class="hash-link" aria-label="Direct link to Structure" title="Direct link to Structure">​</a></h4>
<!-- -->
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="operations">Operations<a href="#operations" class="hash-link" aria-label="Direct link to Operations" title="Direct link to Operations">​</a></h4>
<p><strong>Add Operation</strong> (when song is played):</p>
<div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token maybe-class-name">For</span><span class="token plain"> each hash </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">function</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">h_i</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token parameter">i </span><span class="token parameter operator">=</span><span class="token parameter"> </span><span class="token parameter number">1</span><span class="token parameter"> to depth</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token operator">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  index </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">h_i</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">songId</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token operator">%</span><span class="token plain"> width</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  table</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">i</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">index</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"> </span><span class="token operator">+=</span><span class="token plain"> </span><span class="token number">1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>Estimate Operation</strong> (get play count):</p>
<div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">estimates </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token maybe-class-name">For</span><span class="token plain"> each hash </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">function</span><span class="token plain"> </span><span class="token literal-property property">h_i</span><span class="token operator">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  index </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">h_i</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">songId</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token operator">%</span><span class="token plain"> width</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  estimates</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">append</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">table</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">i</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">index</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword control-flow" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">min</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">estimates</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)">// Conservative estimate</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="why-minimum">Why Minimum?<a href="#why-minimum" class="hash-link" aria-label="Direct link to Why Minimum?" title="Direct link to Why Minimum?">​</a></h4>
<p>The minimum across rows gives the best estimate because:</p>
<ul>
<li>Each counter may have hash collisions (overcount)</li>
<li>The true count is ≤ all row values</li>
<li>Taking minimum reduces collision impact</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="parameter-selection">Parameter Selection<a href="#parameter-selection" class="hash-link" aria-label="Direct link to Parameter Selection" title="Direct link to Parameter Selection">​</a></h4>
<p>Given desired accuracy (ε) and confidence (δ):</p>
<ul>
<li>
<p><strong>Width</strong> = ⌈e / ε⌉</p>
<ul>
<li>ε = 0.01 (1% error) → width ≈ 272</li>
</ul>
</li>
<li>
<p><strong>Depth</strong> = ⌈ln(1/δ)⌉</p>
<ul>
<li>δ = 0.001 (99.9% confidence) → depth ≈ 7</li>
</ul>
</li>
</ul>
<p><strong>Memory Usage</strong>: depth × width × 4 bytes (int)</p>
<ul>
<li>Example: 7 × 272 × 4 = 7.6 KB per CMS!</li>
</ul>
<hr>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="4-top-k-heap">4. Top-K Heap<a href="#4-top-k-heap" class="hash-link" aria-label="Direct link to 4. Top-K Heap" title="Direct link to 4. Top-K Heap">​</a></h3>
<p><strong>Purpose</strong>: Maintain the K most played songs efficiently</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="structure-1">Structure<a href="#structure-1" class="hash-link" aria-label="Direct link to Structure" title="Direct link to Structure">​</a></h4>
<p><strong>Min-Heap</strong> of size K:</p>
<!-- -->
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="operations-1">Operations<a href="#operations-1" class="hash-link" aria-label="Direct link to Operations" title="Direct link to Operations">​</a></h4>
<p><strong>Insert/Update</strong>:</p>
<div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token maybe-class-name">When</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">new</span><span class="token plain"> </span><span class="token class-name">count</span><span class="token plain"> estimate arrives</span><span class="token operator">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token constant" style="color:rgb(189, 147, 249)">IF</span><span class="token plain"> heap</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">size</span><span class="token plain"> </span><span class="token operator">&lt;</span><span class="token plain"> </span><span class="token constant" style="color:rgb(189, 147, 249)">K</span><span class="token operator">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    heap</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">insert</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">song</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> count</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token constant" style="color:rgb(189, 147, 249)">ELSE</span><span class="token plain"> </span><span class="token constant" style="color:rgb(189, 147, 249)">IF</span><span class="token plain"> count </span><span class="token operator">&gt;</span><span class="token plain"> heap</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">peek</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">count</span><span class="token operator">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    heap</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">pop</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain">           </span><span class="token comment" style="color:rgb(98, 114, 164)">// Remove minimum</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    heap</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">insert</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">song</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> count</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>Query Top-K</strong>:</p>
<div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token maybe-class-name">Return</span><span class="token plain"> all elements </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">in</span><span class="token plain"> heap</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> sorted descending</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token literal-property property">Time</span><span class="token operator">:</span><span class="token plain"> </span><span class="token constant" style="color:rgb(189, 147, 249)">O</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token constant" style="color:rgb(189, 147, 249)">K</span><span class="token plain"> log </span><span class="token constant" style="color:rgb(189, 147, 249)">K</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>Why Min-Heap?</strong></p>
<ul>
<li>Root always has the smallest count in Top-K</li>
<li>Easy to check if new song qualifies: compare with root</li>
<li>O(log K) insert/delete operations</li>
</ul>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="data-flow-play-event-processing">Data Flow: Play Event Processing<a href="#data-flow-play-event-processing" class="hash-link" aria-label="Direct link to Data Flow: Play Event Processing" title="Direct link to Data Flow: Play Event Processing">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="sequence-diagram">Sequence Diagram<a href="#sequence-diagram" class="hash-link" aria-label="Direct link to Sequence Diagram" title="Direct link to Sequence Diagram">​</a></h3>
<!-- -->
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="step-by-step-flow">Step-by-Step Flow<a href="#step-by-step-flow" class="hash-link" aria-label="Direct link to Step-by-Step Flow" title="Direct link to Step-by-Step Flow">​</a></h3>
<ol>
<li>
<p><strong>Event Ingestion</strong> (1-5 ms)</p>
<ul>
<li>Client sends play event to Load Balancer</li>
<li>Event published to Kafka topic</li>
<li>Kafka acknowledges write</li>
</ul>
</li>
<li>
<p><strong>Stream Processing</strong> (10-20 ms)</p>
<ul>
<li>Flink consumer reads from Kafka partition</li>
<li>Extracts songId from event</li>
<li>Updates Count-Min Sketch in memory</li>
</ul>
</li>
<li>
<p><strong>Count Estimation</strong> (&lt; 1 ms)</p>
<ul>
<li>Query CMS for updated count</li>
<li>Hash songId with all hash functions</li>
<li>Return minimum value across rows</li>
</ul>
</li>
<li>
<p><strong>Top-K Update</strong> (&lt; 1 ms)</p>
<ul>
<li>Compare estimate with heap minimum</li>
<li>If higher, replace minimum in heap</li>
<li>Rebalance heap</li>
</ul>
</li>
<li>
<p><strong>Persistence</strong> (Async, periodic)</p>
<ul>
<li>Batch write CMS snapshots to Redis (every 10s)</li>
<li>Write Top-K to Cassandra (every 5s)</li>
<li>Enables recovery on failure</li>
</ul>
</li>
</ol>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="api-design">API Design<a href="#api-design" class="hash-link" aria-label="Direct link to API Design" title="Direct link to API Design">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="1-record-play-event-internal">1. Record Play Event (Internal)<a href="#1-record-play-event-internal" class="hash-link" aria-label="Direct link to 1. Record Play Event (Internal)" title="Direct link to 1. Record Play Event (Internal)">​</a></h3>
<div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token constant" style="color:rgb(189, 147, 249)">POST</span><span class="token plain"> </span><span class="token operator">/</span><span class="token plain">internal</span><span class="token operator">/</span><span class="token plain">play</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token maybe-class-name">Content</span><span class="token operator">-</span><span class="token maybe-class-name">Type</span><span class="token operator">:</span><span class="token plain"> application</span><span class="token operator">/</span><span class="token plain">json</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token string-property property">&quot;songId&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;550e8400-e29b-41d4-a716-446655440000&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token string-property property">&quot;userId&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;user123&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token string-property property">&quot;timestamp&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">1698765432000</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token string-property property">&quot;metadata&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token string-property property">&quot;device&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;mobile&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token string-property property">&quot;duration&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">180</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token literal-property property">Response</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">202</span><span class="token plain"> </span><span class="token maybe-class-name">Accepted</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="2-get-top-k-songs">2. Get Top-K Songs<a href="#2-get-top-k-songs" class="hash-link" aria-label="Direct link to 2. Get Top-K Songs" title="Direct link to 2. Get Top-K Songs">​</a></h3>
<div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token constant" style="color:rgb(189, 147, 249)">GET</span><span class="token plain"> </span><span class="token operator">/</span><span class="token plain">api</span><span class="token operator">/</span><span class="token plain">v1</span><span class="token operator">/</span><span class="token plain">topSongs</span><span class="token operator">?</span><span class="token plain">k</span><span class="token operator">=</span><span class="token number">100</span><span class="token operator">&amp;</span><span class="token plain">timeWindow</span><span class="token operator">=</span><span class="token plain">24h</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token literal-property property">Response</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">200</span><span class="token plain"> </span><span class="token constant" style="color:rgb(189, 147, 249)">OK</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token string-property property">&quot;timestamp&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">1698765432000</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token string-property property">&quot;window&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;24h&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token string-property property">&quot;results&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token string-property property">&quot;rank&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token string-property property">&quot;songId&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;abc123&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token string-property property">&quot;title&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;Shape of You&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token string-property property">&quot;artist&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;Ed Sheeran&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token string-property property">&quot;playCount&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">5210320</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token string-property property">&quot;confidence&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">0.999</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token string-property property">&quot;rank&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">2</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token string-property property">&quot;songId&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;def456&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token string-property property">&quot;title&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;Blinding Lights&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token string-property property">&quot;artist&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;The Weeknd&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token string-property property">&quot;playCount&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">4901005</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token string-property property">&quot;confidence&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">0.999</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">// ... 98 more</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="3-get-song-count">3. Get Song Count<a href="#3-get-song-count" class="hash-link" aria-label="Direct link to 3. Get Song Count" title="Direct link to 3. Get Song Count">​</a></h3>
<div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token constant" style="color:rgb(189, 147, 249)">GET</span><span class="token plain"> </span><span class="token operator">/</span><span class="token plain">api</span><span class="token operator">/</span><span class="token plain">v1</span><span class="token operator">/</span><span class="token plain">songs</span><span class="token operator">/</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">songId</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token operator">/</span><span class="token plain">playCount</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token literal-property property">Response</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">200</span><span class="token plain"> </span><span class="token constant" style="color:rgb(189, 147, 249)">OK</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token string-property property">&quot;songId&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;abc123&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token string-property property">&quot;playCount&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">5210320</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token string-property property">&quot;isApproximate&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token string-property property">&quot;errorBound&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;±1%&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="distributed-system-design">Distributed System Design<a href="#distributed-system-design" class="hash-link" aria-label="Direct link to Distributed System Design" title="Direct link to Distributed System Design">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="scaling-strategy">Scaling Strategy<a href="#scaling-strategy" class="hash-link" aria-label="Direct link to Scaling Strategy" title="Direct link to Scaling Strategy">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="horizontal-scaling">Horizontal Scaling<a href="#horizontal-scaling" class="hash-link" aria-label="Direct link to Horizontal Scaling" title="Direct link to Horizontal Scaling">​</a></h4>
<div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    ┌─────────────┐</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    │Load </span><span class="token maybe-class-name">Balancer│</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    └──────┬──────┘</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                           │</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        ┌───────────── ─────┼──────────────────┐</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        ▼                  ▼                  ▼</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   ┌─────────┐        ┌─────────┐       ┌─────────┐</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   │ </span><span class="token maybe-class-name">Kafka</span><span class="token plain">   │        │ </span><span class="token maybe-class-name">Kafka</span><span class="token plain">   │       │ </span><span class="token maybe-class-name">Kafka</span><span class="token plain">   │</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   │Partition│        │Partition│       │Partition│</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   │   </span><span class="token number">0</span><span class="token plain">     │        │   </span><span class="token number">1</span><span class="token plain">     │       │   </span><span class="token number">2</span><span class="token plain">     │</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   └────┬────┘        └────┬────┘       └────┬────┘</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        │                  │                  │</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        ▼                  ▼                  ▼</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   ┌─────────┐        ┌─────────┐       ┌─────────┐</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   │ </span><span class="token maybe-class-name">Flink</span><span class="token plain">   │        │ </span><span class="token maybe-class-name">Flink</span><span class="token plain">   │       │ </span><span class="token maybe-class-name">Flink</span><span class="token plain">   │</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   │ </span><span class="token maybe-class-name">Worker</span><span class="token plain">  │        │ </span><span class="token maybe-class-name">Worker</span><span class="token plain">  │       │ </span><span class="token maybe-class-name">Worker</span><span class="token plain">  │</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   │   </span><span class="token number">1</span><span class="token plain">     │        │   </span><span class="token number">2</span><span class="token plain">     │       │   </span><span class="token number">3</span><span class="token plain">     │</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   │         │        │         │       │         │</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   │ </span><span class="token constant" style="color:rgb(189, 147, 249)">CMS</span><span class="token plain"> </span><span class="token operator">+</span><span class="token plain">   │        │ </span><span class="token constant" style="color:rgb(189, 147, 249)">CMS</span><span class="token plain"> </span><span class="token operator">+</span><span class="token plain">   │       │ </span><span class="token constant" style="color:rgb(189, 147, 249)">CMS</span><span class="token plain"> </span><span class="token operator">+</span><span class="token plain">   │</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   │ </span><span class="token maybe-class-name">TopK</span><span class="token plain">    │        │ </span><span class="token maybe-class-name">TopK</span><span class="token plain">    │       │ </span><span class="token maybe-class-name">TopK</span><span class="token plain">    │</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   └────┬────┘        └────┬────┘       └────┬────┘</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        │                  │                  │</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        └──────────────────┼──────────────────┘</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                           ▼</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    ┌─────────────┐</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    │  </span><span class="token maybe-class-name">Combiner</span><span class="token plain">   │</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    │   </span><span class="token maybe-class-name">Service</span><span class="token plain">   │</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    └─────────────┘</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="cms-merge-operation">CMS Merge Operation<a href="#cms-merge-operation" class="hash-link" aria-label="Direct link to CMS Merge Operation" title="Direct link to CMS Merge Operation">​</a></h4>
<p>Each worker maintains local CMS. Periodically merge:</p>
<div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token maybe-class-name">Global</span><span class="token plain"> </span><span class="token constant" style="color:rgb(189, 147, 249)">CMS</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">i</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">j</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token maybe-class-name">Worker1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token constant" style="color:rgb(189, 147, 249)">CMS</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">i</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">j</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"> </span><span class="token operator">+</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                   </span><span class="token maybe-class-name">Worker2</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token constant" style="color:rgb(189, 147, 249)">CMS</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">i</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">j</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"> </span><span class="token operator">+</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                   </span><span class="token maybe-class-name">Worker3</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token constant" style="color:rgb(189, 147, 249)">CMS</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">i</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">j</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>Properties</strong>:</p>
<ul>
<li>Commutative: A + B = B + A</li>
<li>Associative: (A + B) + C = A + (B + C)</li>
<li>Perfect for distributed aggregation</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="top-k-merge">Top-K Merge<a href="#top-k-merge" class="hash-link" aria-label="Direct link to Top-K Merge" title="Direct link to Top-K Merge">​</a></h4>
<p>Each worker reports local Top-K. Combiner:</p>
<div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token number">1.</span><span class="token plain"> </span><span class="token maybe-class-name">Collect</span><span class="token plain"> all local </span><span class="token maybe-class-name">Top</span><span class="token operator">-</span><span class="token constant" style="color:rgb(189, 147, 249)">K</span><span class="token plain"> lists</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token number">2.</span><span class="token plain"> </span><span class="token maybe-class-name">Merge</span><span class="token plain"> into single list</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token number">3.</span><span class="token plain"> </span><span class="token maybe-class-name">Sort</span><span class="token plain"> by count descending</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token number">4.</span><span class="token plain"> </span><span class="token maybe-class-name">Take</span><span class="token plain"> top </span><span class="token constant" style="color:rgb(189, 147, 249)">K</span><span class="token plain"> elements</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="optimizations">Optimizations<a href="#optimizations" class="hash-link" aria-label="Direct link to Optimizations" title="Direct link to Optimizations">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="1-time-window-analysis">1. Time-Window Analysis<a href="#1-time-window-analysis" class="hash-link" aria-label="Direct link to 1. Time-Window Analysis" title="Direct link to 1. Time-Window Analysis">​</a></h3>
<p><strong>Challenge</strong>: Track Top-K for different time windows (last hour, day, week)</p>
<p><strong>Solution</strong>: Multiple CMS instances per time window</p>
<div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">┌──────────────────────────┐</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">│   </span><span class="token constant" style="color:rgb(189, 147, 249)">CMS</span><span class="token plain"> </span><span class="token maybe-class-name">Manager</span><span class="token plain">            │</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">│                          │</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">│  ├─ </span><span class="token function maybe-class-name" style="color:rgb(80, 250, 123)">CMS_1h</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">last hour</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain">   │</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">│  ├─ </span><span class="token function maybe-class-name" style="color:rgb(80, 250, 123)">CMS_24h</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">last day</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain">   │</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">│  └─ </span><span class="token function maybe-class-name" style="color:rgb(80, 250, 123)">CMS_7d</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">last week</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain">   │</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">└──────────────────────────┘</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>Sliding Window Implementation</strong>:</p>
<ul>
<li>Divide time into small buckets (e.g., 5-minute buckets)</li>
<li>Maintain CMS per bucket</li>
<li>Sum relevant buckets for query window</li>
<li>Expire old buckets</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="2-heavy-hitters-detection">2. Heavy Hitters Detection<a href="#2-heavy-hitters-detection" class="hash-link" aria-label="Direct link to 2. Heavy Hitters Detection" title="Direct link to 2. Heavy Hitters Detection">​</a></h3>
<p><strong>Optimization</strong>: Use Space-Saving Algorithm alongside CMS</p>
<p>Maintain small hash map (10K entries) for frequent items:</p>
<ul>
<li>Track exact counts for songs that appear frequently</li>
<li>Falls back to CMS for less popular songs</li>
<li>Reduces error for top songs</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="3-bloom-filter-pre-filtering">3. Bloom Filter Pre-filtering<a href="#3-bloom-filter-pre-filtering" class="hash-link" aria-label="Direct link to 3. Bloom Filter Pre-filtering" title="Direct link to 3. Bloom Filter Pre-filtering">​</a></h3>
<p><strong>Use Case</strong>: Reduce CMS updates for invalid/test plays</p>
<div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token maybe-class-name">Bloom</span><span class="token plain"> </span><span class="token maybe-class-name">Filter</span><span class="token plain"> → </span><span class="token maybe-class-name">Check</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> songId exists</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">              ↓</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">           </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token constant" style="color:rgb(189, 147, 249)">YES</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"> → </span><span class="token maybe-class-name">Update</span><span class="token plain"> </span><span class="token constant" style="color:rgb(189, 147, 249)">CMS</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">           </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token constant" style="color:rgb(189, 147, 249)">NO</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain">  → </span><span class="token function maybe-class-name" style="color:rgb(80, 250, 123)">Reject</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">invalid song</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="4-caching-layer">4. Caching Layer<a href="#4-caching-layer" class="hash-link" aria-label="Direct link to 4. Caching Layer" title="Direct link to 4. Caching Layer">​</a></h3>
<div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">┌─────────────────────────┐</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">│   </span><span class="token constant" style="color:rgb(189, 147, 249)">CDN</span><span class="token plain"> </span><span class="token operator">/</span><span class="token plain"> </span><span class="token maybe-class-name">Edge</span><span class="token plain"> </span><span class="token maybe-class-name">Cache</span><span class="token plain">      │</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">│</span><span class="token plain">   </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token maybe-class-name">Top</span><span class="token operator">-</span><span class="token constant" style="color:rgb(189, 147, 249)">K</span><span class="token plain"> results</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain">       │</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">│   </span><span class="token constant" style="color:rgb(189, 147, 249)">TTL</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">30</span><span class="token plain"> seconds       │</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">└───────────┬─────────────┘</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            │</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">┌───────────▼─────────────┐</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">│   </span><span class="token maybe-class-name">Redis</span><span class="token plain"> </span><span class="token maybe-class-name">Cache</span><span class="token plain">           │</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">│</span><span class="token plain">   </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token constant" style="color:rgb(189, 147, 249)">CMS</span><span class="token plain"> snapshots</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain">       │</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">│   </span><span class="token constant" style="color:rgb(189, 147, 249)">TTL</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">5</span><span class="token plain"> minutes        │</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">└───────────┬─────────────┘</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            │</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">┌───────────▼─────────────┐</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">│   </span><span class="token maybe-class-name">Primary</span><span class="token plain"> </span><span class="token maybe-class-name">Storage</span><span class="token plain">       │</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">│</span><span class="token plain">   </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token maybe-class-name">Cassandra</span><span class="token operator">/</span><span class="token maybe-class-name">DynamoDB</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain">  │</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">└─────────────────────────┘</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="storage-layer">Storage Layer<a href="#storage-layer" class="hash-link" aria-label="Direct link to Storage Layer" title="Direct link to Storage Layer">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="redis-in-memory-cache">Redis (In-Memory Cache)<a href="#redis-in-memory-cache" class="hash-link" aria-label="Direct link to Redis (In-Memory Cache)" title="Direct link to Redis (In-Memory Cache)">​</a></h3>
<p><strong>Purpose</strong>: Fast access to CMS and recent Top-K</p>
<p><strong>Data Structure</strong>:</p>
<div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token literal-property property">Key</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;cms:{timeWindow}&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token literal-property property">Value</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">Serialized</span><span class="token plain"> </span><span class="token constant" style="color:rgb(189, 147, 249)">CMS</span><span class="token plain"> array</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token constant" style="color:rgb(189, 147, 249)">TTL</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">1</span><span class="token plain"> hour</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token literal-property property">Key</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;topk:{timeWindow}&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token literal-property property">Value</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">Sorted</span><span class="token plain"> </span><span class="token known-class-name class-name">Set</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">song → count</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token constant" style="color:rgb(189, 147, 249)">TTL</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">5</span><span class="token plain"> minutes</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="cassandra-persistent-storage">Cassandra (Persistent Storage)<a href="#cassandra-persistent-storage" class="hash-link" aria-label="Direct link to Cassandra (Persistent Storage)" title="Direct link to Cassandra (Persistent Storage)">​</a></h3>
<p><strong>Table Schema</strong>:</p>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">TABLE</span><span class="token plain"> song_stats </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  song_id UUID</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  time_bucket </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">TIMESTAMP</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  play_count </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">BIGINT</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">PRIMARY</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">KEY</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">time_bucket</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> play_count</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> song_id</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">WITH</span><span class="token plain"> CLUSTERING </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">ORDER</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">BY</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">play_count </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">DESC</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>Benefits</strong>:</p>
<ul>
<li>Partition by time bucket</li>
<li>Cluster by play_count (descending)</li>
<li>Fast Top-K queries</li>
</ul>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="capacity-estimation">Capacity Estimation<a href="#capacity-estimation" class="hash-link" aria-label="Direct link to Capacity Estimation" title="Direct link to Capacity Estimation">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="traffic">Traffic<a href="#traffic" class="hash-link" aria-label="Direct link to Traffic" title="Direct link to Traffic">​</a></h3>
<ul>
<li><strong>Daily Active Users</strong>: 400M</li>
<li><strong>Avg Songs/User/Day</strong>: 20</li>
<li><strong>Total Plays/Day</strong>: 8 billion</li>
<li><strong>Plays/Second</strong>: ~92,000 (peak: 300,000)</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="storage">Storage<a href="#storage" class="hash-link" aria-label="Direct link to Storage" title="Direct link to Storage">​</a></h3>
<p><strong>Count-Min Sketch</strong>:</p>
<ul>
<li>Depth: 7, Width: 272</li>
<li>Per CMS: 7.6 KB</li>
<li>3 time windows × 3 replicas: 68 KB total</li>
</ul>
<p><strong>Top-K Heap</strong> (K=1000):</p>
<ul>
<li>Per entry: 16 bytes (songId) + 8 bytes (count)</li>
<li>Total: 24 KB × 3 windows = 72 KB</li>
</ul>
<p><strong>Total Memory per Worker</strong>: &lt; 200 KB (incredibly efficient!)</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="network">Network<a href="#network" class="hash-link" aria-label="Direct link to Network" title="Direct link to Network">​</a></h3>
<ul>
<li>Event size: ~200 bytes</li>
<li>Kafka throughput: 300K events/s × 200 bytes = 60 MB/s</li>
<li>Distributed across partitions</li>
</ul>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="fault-tolerance">Fault Tolerance<a href="#fault-tolerance" class="hash-link" aria-label="Direct link to Fault Tolerance" title="Direct link to Fault Tolerance">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="strategies">Strategies<a href="#strategies" class="hash-link" aria-label="Direct link to Strategies" title="Direct link to Strategies">​</a></h3>
<ol>
<li>
<p><strong>Kafka Replication</strong></p>
<ul>
<li>Replication factor: 3</li>
<li>Min in-sync replicas: 2</li>
<li>Leader election automatic</li>
</ul>
</li>
<li>
<p><strong>Flink Checkpointing</strong></p>
<ul>
<li>Periodic snapshots (1 min)</li>
<li>State stored in distributed FS</li>
<li>Exactly-once processing semantics</li>
</ul>
</li>
<li>
<p><strong>Redis Sentinel/Cluster</strong></p>
<ul>
<li>Master-slave replication</li>
<li>Automatic failover</li>
<li>No single point of failure</li>
</ul>
</li>
<li>
<p><strong>Cassandra Multi-DC</strong></p>
<ul>
<li>Data replicated across 3 DCs</li>
<li>Quorum reads/writes</li>
<li>Self-healing ring architecture</li>
</ul>
</li>
</ol>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="trade-offs--considerations">Trade-offs &amp; Considerations<a href="#trade-offs--considerations" class="hash-link" aria-label="Direct link to Trade-offs &amp; Considerations" title="Direct link to Trade-offs &amp; Considerations">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="accuracy-vs-memory">Accuracy vs Memory<a href="#accuracy-vs-memory" class="hash-link" aria-label="Direct link to Accuracy vs Memory" title="Direct link to Accuracy vs Memory">​</a></h3>
<ul>
<li><strong>Exact counting</strong>: Requires hashmap = O(N) space for N songs</li>
<li><strong>CMS</strong>: O(1/ε × log(1/δ)) space, independent of N</li>
<li><strong>Trade-off</strong>: Accept 1% error for 1000× memory savings</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="latency-vs-freshness">Latency vs Freshness<a href="#latency-vs-freshness" class="hash-link" aria-label="Direct link to Latency vs Freshness" title="Direct link to Latency vs Freshness">​</a></h3>
<ul>
<li><strong>Real-time updates</strong>: Higher CPU cost</li>
<li><strong>Batch updates</strong>: Lower cost, slightly stale data</li>
<li><strong>Choice</strong>: Micro-batching (100ms windows)</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="consistency-vs-availability">Consistency vs Availability<a href="#consistency-vs-availability" class="hash-link" aria-label="Direct link to Consistency vs Availability" title="Direct link to Consistency vs Availability">​</a></h3>
<ul>
<li><strong>Strong consistency</strong>: Synchronized global state (slow)</li>
<li><strong>Eventual consistency</strong>: Faster, temporary inconsistencies</li>
<li><strong>Choice</strong>: Eventual consistency acceptable for analytics</li>
</ul>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="monitoring--observability">Monitoring &amp; Observability<a href="#monitoring--observability" class="hash-link" aria-label="Direct link to Monitoring &amp; Observability" title="Direct link to Monitoring &amp; Observability">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="key-metrics">Key Metrics<a href="#key-metrics" class="hash-link" aria-label="Direct link to Key Metrics" title="Direct link to Key Metrics">​</a></h3>
<ol>
<li>
<p><strong>Throughput</strong></p>
<ul>
<li>Events/second processed</li>
<li>Kafka lag per partition</li>
</ul>
</li>
<li>
<p><strong>Latency</strong></p>
<ul>
<li>P50, P95, P99 processing time</li>
<li>End-to-end event latency</li>
</ul>
</li>
<li>
<p><strong>Accuracy</strong></p>
<ul>
<li>Compare CMS estimates vs exact counts (sample)</li>
<li>Track error distribution</li>
</ul>
</li>
<li>
<p><strong>Resource Usage</strong></p>
<ul>
<li>CPU per Flink worker</li>
<li>Memory per CMS instance</li>
<li>Network bandwidth</li>
</ul>
</li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="alerting">Alerting<a href="#alerting" class="hash-link" aria-label="Direct link to Alerting" title="Direct link to Alerting">​</a></h3>
<ul>
<li>Kafka lag &gt; 10K messages</li>
<li>Processing latency &gt; 100ms (P95)</li>
<li>Flink worker failures</li>
<li>Error rate &gt; 0.1%</li>
</ul>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="summary">Summary<a href="#summary" class="hash-link" aria-label="Direct link to Summary" title="Direct link to Summary">​</a></h2>
<p>This system achieves:</p>
<ul>
<li>✅ <strong>Scalability</strong>: Processes millions of plays/second.</li>
<li>✅ <strong>Efficiency</strong>: &lt; 200 KB memory per worker.</li>
<li>✅ <strong>Accuracy</strong>: 99%+ accurate with configurable bounds.</li>
<li>✅ <strong>Fault Tolerance</strong>: No single point of failure.</li>
<li>✅ <strong>Low Latency</strong>: Sub-100ms Top-K queries.</li>
</ul>
<p><strong>Key Innovation</strong>: Count-Min Sketch enables probabilistic counting at massive scale with minimal resources, making real-time analytics feasible.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/carefree-ladka/docs/High Level Designs/System Design: Spotify Top-K Songs Tracker.mdx" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/High Level Designs/Social Media Timeline Design - HLD Architecture"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Social Media Timeline Design - HLD Architecture 📰</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/High Level Designs/System Design: Top-K YouTube Videos"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">System Design: Top-K YouTube Videos</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#problem-statement" class="table-of-contents__link toc-highlight">Problem Statement</a></li><li><a href="#requirements" class="table-of-contents__link toc-highlight">Requirements</a><ul><li><a href="#functional-requirements" class="table-of-contents__link toc-highlight">Functional Requirements</a></li><li><a href="#non-functional-requirements" class="table-of-contents__link toc-highlight">Non-Functional Requirements</a></li></ul></li><li><a href="#high-level-architecture" class="table-of-contents__link toc-highlight">High-Level Architecture</a></li><li><a href="#core-components" class="table-of-contents__link toc-highlight">Core Components</a><ul><li><a href="#1-event-stream-apache-kafka" class="table-of-contents__link toc-highlight">1. Event Stream (Apache Kafka)</a></li><li><a href="#2-stream-processing-layer-apache-flink" class="table-of-contents__link toc-highlight">2. Stream Processing Layer (Apache Flink)</a></li><li><a href="#3-count-min-sketch-cms" class="table-of-contents__link toc-highlight">3. Count-Min Sketch (CMS)</a></li><li><a href="#4-top-k-heap" class="table-of-contents__link toc-highlight">4. Top-K Heap</a></li></ul></li><li><a href="#data-flow-play-event-processing" class="table-of-contents__link toc-highlight">Data Flow: Play Event Processing</a><ul><li><a href="#sequence-diagram" class="table-of-contents__link toc-highlight">Sequence Diagram</a></li><li><a href="#step-by-step-flow" class="table-of-contents__link toc-highlight">Step-by-Step Flow</a></li></ul></li><li><a href="#api-design" class="table-of-contents__link toc-highlight">API Design</a><ul><li><a href="#1-record-play-event-internal" class="table-of-contents__link toc-highlight">1. Record Play Event (Internal)</a></li><li><a href="#2-get-top-k-songs" class="table-of-contents__link toc-highlight">2. Get Top-K Songs</a></li><li><a href="#3-get-song-count" class="table-of-contents__link toc-highlight">3. Get Song Count</a></li></ul></li><li><a href="#distributed-system-design" class="table-of-contents__link toc-highlight">Distributed System Design</a><ul><li><a href="#scaling-strategy" class="table-of-contents__link toc-highlight">Scaling Strategy</a></li></ul></li><li><a href="#optimizations" class="table-of-contents__link toc-highlight">Optimizations</a><ul><li><a href="#1-time-window-analysis" class="table-of-contents__link toc-highlight">1. Time-Window Analysis</a></li><li><a href="#2-heavy-hitters-detection" class="table-of-contents__link toc-highlight">2. Heavy Hitters Detection</a></li><li><a href="#3-bloom-filter-pre-filtering" class="table-of-contents__link toc-highlight">3. Bloom Filter Pre-filtering</a></li><li><a href="#4-caching-layer" class="table-of-contents__link toc-highlight">4. Caching Layer</a></li></ul></li><li><a href="#storage-layer" class="table-of-contents__link toc-highlight">Storage Layer</a><ul><li><a href="#redis-in-memory-cache" class="table-of-contents__link toc-highlight">Redis (In-Memory Cache)</a></li><li><a href="#cassandra-persistent-storage" class="table-of-contents__link toc-highlight">Cassandra (Persistent Storage)</a></li></ul></li><li><a href="#capacity-estimation" class="table-of-contents__link toc-highlight">Capacity Estimation</a><ul><li><a href="#traffic" class="table-of-contents__link toc-highlight">Traffic</a></li><li><a href="#storage" class="table-of-contents__link toc-highlight">Storage</a></li><li><a href="#network" class="table-of-contents__link toc-highlight">Network</a></li></ul></li><li><a href="#fault-tolerance" class="table-of-contents__link toc-highlight">Fault Tolerance</a><ul><li><a href="#strategies" class="table-of-contents__link toc-highlight">Strategies</a></li></ul></li><li><a href="#trade-offs--considerations" class="table-of-contents__link toc-highlight">Trade-offs &amp; Considerations</a><ul><li><a href="#accuracy-vs-memory" class="table-of-contents__link toc-highlight">Accuracy vs Memory</a></li><li><a href="#latency-vs-freshness" class="table-of-contents__link toc-highlight">Latency vs Freshness</a></li><li><a href="#consistency-vs-availability" class="table-of-contents__link toc-highlight">Consistency vs Availability</a></li></ul></li><li><a href="#monitoring--observability" class="table-of-contents__link toc-highlight">Monitoring &amp; Observability</a><ul><li><a href="#key-metrics" class="table-of-contents__link toc-highlight">Key Metrics</a></li><li><a href="#alerting" class="table-of-contents__link toc-highlight">Alerting</a></li></ul></li><li><a href="#summary" class="table-of-contents__link toc-highlight">Summary</a></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/intro">Getting Started</a></li><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a class="footer__link-item" href="/interviews">Interview Experiences</a></li></ul></div><div class="col footer__col"><div class="footer__title">Connect</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://www.linkedin.com/in/kumpawan/" target="_blank" rel="noopener noreferrer" class="footer__link-item">LinkedIn<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/carefree-ladka" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.instagram.com/carefree_ladka/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Instagram<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://leetcode.com/u/Asyncy99/" target="_blank" rel="noopener noreferrer" class="footer__link-item">LeetCode<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 DevEnigma · Built with Kadak Chai ☕</div></div></div></footer></div>
</body>
</html>