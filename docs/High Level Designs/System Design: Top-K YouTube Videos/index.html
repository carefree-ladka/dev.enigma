<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-High Level Designs/System Design: Top-K YouTube Videos" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.5.2">
<title data-rh="true">System Design: Top-K YouTube Videos | DevEnigma</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://carefree-ladka.in/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://carefree-ladka.in/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://carefree-ladka.in/docs/High Level Designs/System Design: Top-K YouTube Videos"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="System Design: Top-K YouTube Videos | DevEnigma"><meta data-rh="true" name="description" content="A comprehensive guide to designing a real-time system for tracking and displaying the most viewed YouTube videos using stream processing and probabilistic data structures."><meta data-rh="true" property="og:description" content="A comprehensive guide to designing a real-time system for tracking and displaying the most viewed YouTube videos using stream processing and probabilistic data structures."><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://carefree-ladka.in/docs/High Level Designs/System Design: Top-K YouTube Videos"><link data-rh="true" rel="alternate" href="https://carefree-ladka.in/docs/High Level Designs/System Design: Top-K YouTube Videos" hreflang="en"><link data-rh="true" rel="alternate" href="https://carefree-ladka.in/docs/High Level Designs/System Design: Top-K YouTube Videos" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="DevEnigma RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="DevEnigma Atom Feed"><link rel="stylesheet" href="/assets/css/styles.739955cc.css">
<script src="/assets/js/runtime~main.f890fe89.js" defer="defer"></script>
<script src="/assets/js/main.2f85de29.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();null!==e?t(e):window.matchMedia("(prefers-color-scheme: dark)").matches?t("dark"):(window.matchMedia("(prefers-color-scheme: light)").matches,t("light"))}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="DevEnigma Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo.svg" alt="DevEnigma Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">DevEnigma</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/intro">Learning</a><a class="navbar__item navbar__link" href="/interviews">Interview Experiences</a><a class="navbar__item navbar__link" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://www.linkedin.com/in/kumpawan/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">LinkedIn<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/intro">DevEnigma | Learn &amp; Practice</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/college-revision">College Revision</a><button aria-label="Expand sidebar category &#x27;College Revision&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/operating-system">Operating System</a><button aria-label="Expand sidebar category &#x27;Operating System&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/web-development">Web Development</a><button aria-label="Expand sidebar category &#x27;Web Development&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/data-structures--algorithms">Data Structures &amp; Algorithms</a><button aria-label="Expand sidebar category &#x27;Data Structures &amp; Algorithms&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/java-tutorial">Java Tutorial</a><button aria-label="Expand sidebar category &#x27;Java Tutorial&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/company-specific">Company Specific</a><button aria-label="Expand sidebar category &#x27;Company Specific&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/java-multithreading-">Java Multithreading </a><button aria-label="Expand sidebar category &#x27;Java Multithreading &#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/tips--tricks">Tips &amp; Tricks</a><button aria-label="Expand sidebar category &#x27;Tips &amp; Tricks&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/backend-system-design">Backend System Design</a><button aria-label="Expand sidebar category &#x27;Backend System Design&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/node--expressjs">Node &amp; Express.js</a><button aria-label="Expand sidebar category &#x27;Node &amp; Express.js&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/database">Database</a><button aria-label="Expand sidebar category &#x27;Database&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/frontend-system-design">Frontend System Design</a><button aria-label="Expand sidebar category &#x27;Frontend System Design&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/low-level-design">Low Level Design</a><button aria-label="Expand sidebar category &#x27;Low Level Design&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" href="/docs/category/high-level-designs">High Level Designs</a><button aria-label="Collapse sidebar category &#x27;High Level Designs&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/High Level Designs/Rideshare Apps Architecture">Uber/Ola Rideshare Apps Architecture 🚗</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/High Level Designs/Social Media Platforms - HLD Architecture">Social Media Platforms - HLD Architecture 📱</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/High Level Designs/Social Media Timeline Design - HLD Architecture">Social Media Timeline Design - HLD Architecture  📰</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/High Level Designs/System Design: Spotify Top-K Songs Tracker">System Design: Spotify Top-K Songs Tracker</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/High Level Designs/System Design: Top-K YouTube Videos">System Design: Top-K YouTube Videos</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/High Level Designs/Video Streaming">Video Streaming at Scale 🎥</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/system-design">System Design</a><button aria-label="Expand sidebar category &#x27;System Design&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/data-science">Data Science</a><button aria-label="Expand sidebar category &#x27;Data Science&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/java-interview-guide">Java Interview Guide</a><button aria-label="Expand sidebar category &#x27;Java Interview Guide&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/redis">Redis</a><button aria-label="Expand sidebar category &#x27;Redis&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/complete-system-design-interview-guide--2025">Complete System Design Interview Guide — 2025</a><button aria-label="Expand sidebar category &#x27;Complete System Design Interview Guide — 2025&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/spring-boot">Spring Boot</a><button aria-label="Expand sidebar category &#x27;Spring Boot&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/category/high-level-designs"><span itemprop="name">High Level Designs</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">System Design: Top-K YouTube Videos</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>System Design: Top-K YouTube Videos</h1></header>
<p>A comprehensive guide to designing a real-time system for tracking and displaying the most viewed YouTube videos using stream processing and probabilistic data structures.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="1-problem-understanding--requirements">1. Problem Understanding &amp; Requirements<a href="#1-problem-understanding--requirements" class="hash-link" aria-label="Direct link to 1. Problem Understanding &amp; Requirements" title="Direct link to 1. Problem Understanding &amp; Requirements">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="functional-requirements">Functional Requirements<a href="#functional-requirements" class="hash-link" aria-label="Direct link to Functional Requirements" title="Direct link to Functional Requirements">​</a></h3>
<ul>
<li>Track view counts for billions of videos in real-time</li>
<li>Return top-K (e.g., top 100) most viewed videos globally</li>
<li>Support time-windowed queries (last hour, day, week)</li>
<li>Handle video metadata updates</li>
<li>Support regional/category-specific top-K queries</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="non-functional-requirements">Non-Functional Requirements<a href="#non-functional-requirements" class="hash-link" aria-label="Direct link to Non-Functional Requirements" title="Direct link to Non-Functional Requirements">​</a></h3>
<ul>
<li><strong>High Throughput</strong>: Process millions of views per second</li>
<li><strong>Low Latency</strong>: Real-time processing with <code>&lt;1</code> second lag</li>
<li><strong>Scalability</strong>: Horizontal scaling for growing traffic</li>
<li><strong>Approximate Accuracy</strong>: 90-95% accuracy acceptable (trade-off for performance)</li>
<li><strong>Availability</strong>: 99.99% uptime</li>
<li><strong>Cost Efficiency</strong>: Optimize memory and compute resources</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="scale-estimation">Scale Estimation<a href="#scale-estimation" class="hash-link" aria-label="Direct link to Scale Estimation" title="Direct link to Scale Estimation">​</a></h3>
<div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token maybe-class-name">Daily</span><span class="token plain"> </span><span class="token maybe-class-name">Active</span><span class="token plain"> </span><span class="token maybe-class-name">Users</span><span class="token operator">:</span><span class="token plain">        </span><span class="token number">1</span><span class="token plain"> billion</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token maybe-class-name">Videos</span><span class="token plain"> on </span><span class="token maybe-class-name">Platform</span><span class="token operator">:</span><span class="token plain">        </span><span class="token number">2</span><span class="token plain"> billion</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token maybe-class-name">Daily</span><span class="token plain"> </span><span class="token maybe-class-name">Video</span><span class="token plain"> </span><span class="token maybe-class-name">Views</span><span class="token operator">:</span><span class="token plain">         </span><span class="token number">5</span><span class="token plain"> billion</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token maybe-class-name">Average</span><span class="token plain"> </span><span class="token maybe-class-name">Views</span><span class="token operator">/</span><span class="token maybe-class-name">Second</span><span class="token operator">:</span><span class="token plain">      </span><span class="token operator">~</span><span class="token number">58</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token number">000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token maybe-class-name">Peak</span><span class="token plain"> </span><span class="token maybe-class-name">Views</span><span class="token operator">/</span><span class="token maybe-class-name">Second</span><span class="token operator">:</span><span class="token plain">         </span><span class="token operator">~</span><span class="token number">200</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token number">000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token maybe-class-name">View</span><span class="token plain"> </span><span class="token maybe-class-name">Event</span><span class="token plain"> </span><span class="token maybe-class-name">Size</span><span class="token operator">:</span><span class="token plain">           </span><span class="token operator">~</span><span class="token number">500</span><span class="token plain"> bytes</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token maybe-class-name">Daily</span><span class="token plain"> </span><span class="token maybe-class-name">Data</span><span class="token plain"> </span><span class="token maybe-class-name">Volume</span><span class="token operator">:</span><span class="token plain">         </span><span class="token operator">~</span><span class="token number">2.5</span><span class="token plain"> </span><span class="token constant" style="color:rgb(189, 147, 249)">TB</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="2-high-level-architecture">2. High-Level Architecture<a href="#2-high-level-architecture" class="hash-link" aria-label="Direct link to 2. High-Level Architecture" title="Direct link to 2. High-Level Architecture">​</a></h2>
<!-- -->
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="3-core-components-deep-dive">3. Core Components Deep Dive<a href="#3-core-components-deep-dive" class="hash-link" aria-label="Direct link to 3. Core Components Deep Dive" title="Direct link to 3. Core Components Deep Dive">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="31-data-model">3.1 Data Model<a href="#31-data-model" class="hash-link" aria-label="Direct link to 3.1 Data Model" title="Direct link to 3.1 Data Model">​</a></h3>
<p><strong>View Event Schema:</strong></p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">&quot;event_id&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;uuid&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">&quot;video_id&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;string&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">&quot;user_id&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;string&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">&quot;timestamp&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;long&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">&quot;region&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;string&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">&quot;category&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;string&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">&quot;watch_duration&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;int&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">&quot;device_type&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;string&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="32-stream-processing-pipeline">3.2 Stream Processing Pipeline<a href="#32-stream-processing-pipeline" class="hash-link" aria-label="Direct link to 3.2 Stream Processing Pipeline" title="Direct link to 3.2 Stream Processing Pipeline">​</a></h3>
<!-- -->
<p><strong>Stream Processing Flow:</strong></p>
<ol>
<li><strong>Validation Stage</strong>: Filter duplicates, validate schema, check fraud</li>
<li><strong>Counting Stage</strong>: Update Count-Min Sketch for approximate counts</li>
<li><strong>Aggregation Stage</strong>: Maintain heap-based Top-K</li>
<li><strong>Windowing Stage</strong>: Time-based aggregations (tumbling/sliding windows)</li>
</ol>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="4-count-min-sketch-implementation">4. Count-Min Sketch Implementation<a href="#4-count-min-sketch-implementation" class="hash-link" aria-label="Direct link to 4. Count-Min Sketch Implementation" title="Direct link to 4. Count-Min Sketch Implementation">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="what-is-count-min-sketch">What is Count-Min Sketch?<a href="#what-is-count-min-sketch" class="hash-link" aria-label="Direct link to What is Count-Min Sketch?" title="Direct link to What is Count-Min Sketch?">​</a></h3>
<p>A probabilistic data structure that estimates frequency of events in a stream using sub-linear space.</p>
<p><strong>Key Properties:</strong></p>
<ul>
<li>Space: O(w × d) where w = width, d = depth</li>
<li>Update Time: O(d)</li>
<li>Query Time: O(d)</li>
<li>Overestimates, never underestimates</li>
<li>Error bound: ε with probability δ</li>
</ul>
<!-- -->
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="count-min-sketch-algorithm">Count-Min Sketch Algorithm<a href="#count-min-sketch-algorithm" class="hash-link" aria-label="Direct link to Count-Min Sketch Algorithm" title="Direct link to Count-Min Sketch Algorithm">​</a></h3>
<p><strong>Parameters:</strong></p>
<ul>
<li>ε (epsilon): Error tolerance (e.g., 0.01 = 1% error)</li>
<li>δ (delta): Confidence (e.g., 0.99 = 99% confidence)</li>
<li>Width (w): ⌈e/ε⌉ ≈ 272 for ε=0.01</li>
<li>Depth (d): ⌈ln(1/δ)⌉ ≈ 5 for δ=0.01</li>
</ul>
<p><strong>Update Operation:</strong></p>
<div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token maybe-class-name">For</span><span class="token plain"> each hash </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">function</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">h_i</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token parameter">i </span><span class="token parameter operator">=</span><span class="token parameter"> </span><span class="token parameter number">1</span><span class="token parameter"> to d</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token operator">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    index </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">h_i</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">video_id</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> mod w</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    counter</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">i</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">index</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"> </span><span class="token operator">+=</span><span class="token plain"> </span><span class="token number">1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>Query Operation:</strong></p>
<div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">estimated_count </span><span class="token operator">=</span><span class="token plain"> </span><span class="token constant" style="color:rgb(189, 147, 249)">MIN</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">counter</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">i</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token function" style="color:rgb(80, 250, 123)">h_i</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">video_id</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> mod w</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:rgb(189, 147, 249);font-style:italic">for</span><span class="token plain"> all i</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="why-count-min-sketch-for-youtube">Why Count-Min Sketch for YouTube?<a href="#why-count-min-sketch-for-youtube" class="hash-link" aria-label="Direct link to Why Count-Min Sketch for YouTube?" title="Direct link to Why Count-Min Sketch for YouTube?">​</a></h3>
<p><strong>Memory Comparison:</strong></p>
<table><thead><tr><th>Approach</th><th>Memory Required</th></tr></thead><tbody><tr><td>Exact Counters (2B videos)</td><td>16 GB (8 bytes × 2B)</td></tr><tr><td>Count-Min Sketch</td><td>~10 MB (272 × 5 × 8 bytes)</td></tr></tbody></table>
<p><strong>Space Savings: 1,600x reduction!</strong></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="5-top-k-algorithm-design">5. Top-K Algorithm Design<a href="#5-top-k-algorithm-design" class="hash-link" aria-label="Direct link to 5. Top-K Algorithm Design" title="Direct link to 5. Top-K Algorithm Design">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="heap-based-approach">Heap-Based Approach<a href="#heap-based-approach" class="hash-link" aria-label="Direct link to Heap-Based Approach" title="Direct link to Heap-Based Approach">​</a></h3>
<!-- -->
<p><strong>Algorithm Steps:</strong></p>
<ol>
<li><strong>Initialize</strong>: Create min-heap of size K</li>
<li><strong>For each view event</strong>:<!-- -->
<ul>
<li>Update Count-Min Sketch</li>
<li>Get estimated count from CMS</li>
<li>If count &gt; heap minimum:<!-- -->
<ul>
<li>Remove minimum from heap</li>
<li>Insert (video_id, count) into heap</li>
</ul>
</li>
</ul>
</li>
<li><strong>Periodically sync heap to Redis</strong> (every 1-5 seconds)</li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="space-saving-algorithm-alternative">Space-Saving Algorithm (Alternative)<a href="#space-saving-algorithm-alternative" class="hash-link" aria-label="Direct link to Space-Saving Algorithm (Alternative)" title="Direct link to Space-Saving Algorithm (Alternative)">​</a></h3>
<p>Maintains K counters for heavy hitters with guaranteed error bounds:</p>
<ul>
<li>Space: O(K)</li>
<li>Better accuracy than pure Count-Min Sketch</li>
<li>Combines frequency estimation with Top-K</li>
</ul>
<!-- -->
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="6-time-window-processing">6. Time Window Processing<a href="#6-time-window-processing" class="hash-link" aria-label="Direct link to 6. Time Window Processing" title="Direct link to 6. Time Window Processing">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="window-types">Window Types<a href="#window-types" class="hash-link" aria-label="Direct link to Window Types" title="Direct link to Window Types">​</a></h3>
<!-- -->
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="multi-window-architecture">Multi-Window Architecture<a href="#multi-window-architecture" class="hash-link" aria-label="Direct link to Multi-Window Architecture" title="Direct link to Multi-Window Architecture">​</a></h3>
<!-- -->
<p><strong>Implementation with Apache Flink:</strong></p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token class-name">DataStream</span><span class="token generics punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token generics class-name">ViewEvent</span><span class="token generics punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"> views </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// 1-hour tumbling window</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token class-name">DataStream</span><span class="token generics punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token generics class-name">TopK</span><span class="token generics punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"> hourlyTopK </span><span class="token operator">=</span><span class="token plain"> views</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">keyBy</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token class-name">ViewEvent</span><span class="token operator">::</span><span class="token function" style="color:rgb(80, 250, 123)">getVideoId</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">window</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token class-name">TumblingEventTimeWindows</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">of</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token class-name">Time</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">hours</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token number">1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">aggregate</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">new</span><span class="token plain"> </span><span class="token class-name">CountMinSketchAggregator</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">process</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">new</span><span class="token plain"> </span><span class="token class-name">TopKFunction</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token number">100</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// 24-hour sliding window (slide every hour)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token class-name">DataStream</span><span class="token generics punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token generics class-name">TopK</span><span class="token generics punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"> dailyTopK </span><span class="token operator">=</span><span class="token plain"> views</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">keyBy</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token class-name">ViewEvent</span><span class="token operator">::</span><span class="token function" style="color:rgb(80, 250, 123)">getVideoId</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">window</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token class-name">SlidingEventTimeWindows</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">of</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token class-name">Time</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">hours</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token number">24</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token class-name">Time</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">hours</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token number">1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">aggregate</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">new</span><span class="token plain"> </span><span class="token class-name">CountMinSketchAggregator</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">process</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">new</span><span class="token plain"> </span><span class="token class-name">TopKFunction</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token number">100</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="7-database-design">7. Database Design<a href="#7-database-design" class="hash-link" aria-label="Direct link to 7. Database Design" title="Direct link to 7. Database Design">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="redis-schema-hot-data---top-k-cache">Redis Schema (Hot Data - Top-K Cache)<a href="#redis-schema-hot-data---top-k-cache" class="hash-link" aria-label="Direct link to Redis Schema (Hot Data - Top-K Cache)" title="Direct link to Redis Schema (Hot Data - Top-K Cache)">​</a></h3>
<div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token maybe-class-name">Key</span><span class="token plain"> </span><span class="token maybe-class-name">Pattern</span><span class="token operator">:</span><span class="token plain"> topk</span><span class="token operator">:</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token dom variable" style="color:rgb(189, 147, 249);font-style:italic">window</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token operator">:</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">region</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token operator">:</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">category</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token literal-property property">Type</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">Sorted</span><span class="token plain"> </span><span class="token known-class-name class-name">Set</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token constant" style="color:rgb(189, 147, 249)">ZSET</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token literal-property property">Example</span><span class="token operator">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token literal-property property">topk</span><span class="token operator">:</span><span class="token plain">1h</span><span class="token operator">:</span><span class="token plain">global</span><span class="token operator">:</span><span class="token plain">all → </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">video_1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> 1M</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">video_2</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> 900K</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token spread operator">...</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token literal-property property">topk</span><span class="token operator">:</span><span class="token plain">24h</span><span class="token operator">:</span><span class="token constant" style="color:rgb(189, 147, 249)">US</span><span class="token operator">:</span><span class="token plain">music → </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">video_5</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> 5M</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">video_9</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token number">4</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">8M</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token spread operator">...</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token literal-property property">topk</span><span class="token operator">:</span><span class="token plain">7d</span><span class="token operator">:</span><span class="token plain">global</span><span class="token operator">:</span><span class="token plain">gaming → </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">video_12</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> 50M</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token spread operator">...</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token literal-property property">Commands</span><span class="token operator">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token operator">-</span><span class="token plain"> </span><span class="token constant" style="color:rgb(189, 147, 249)">ZADD</span><span class="token plain"> </span><span class="token literal-property property">topk</span><span class="token operator">:</span><span class="token plain">1h</span><span class="token operator">:</span><span class="token plain">global</span><span class="token operator">:</span><span class="token plain">all </span><span class="token number">1000000</span><span class="token plain"> video_1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token operator">-</span><span class="token plain"> </span><span class="token constant" style="color:rgb(189, 147, 249)">ZREVRANGE</span><span class="token plain"> </span><span class="token literal-property property">topk</span><span class="token operator">:</span><span class="token plain">1h</span><span class="token operator">:</span><span class="token plain">global</span><span class="token operator">:</span><span class="token plain">all </span><span class="token number">0</span><span class="token plain"> </span><span class="token number">99</span><span class="token plain"> </span><span class="token constant" style="color:rgb(189, 147, 249)">WITHSCORES</span><span class="token plain">  # </span><span class="token maybe-class-name">Get</span><span class="token plain"> </span><span class="token maybe-class-name">Top</span><span class="token operator">-</span><span class="token number">100</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token operator">-</span><span class="token plain"> </span><span class="token constant" style="color:rgb(189, 147, 249)">ZINCRBY</span><span class="token plain"> </span><span class="token literal-property property">topk</span><span class="token operator">:</span><span class="token plain">1h</span><span class="token operator">:</span><span class="token plain">global</span><span class="token operator">:</span><span class="token plain">all </span><span class="token number">1</span><span class="token plain"> video_1           # </span><span class="token maybe-class-name">Increment</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="cassandra-schema-cold-data---historical">Cassandra Schema (Cold Data - Historical)<a href="#cassandra-schema-cold-data---historical" class="hash-link" aria-label="Direct link to Cassandra Schema (Cold Data - Historical)" title="Direct link to Cassandra Schema (Cold Data - Historical)">​</a></h3>
<div class="language-cql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cql codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">CREATE TABLE video_view_counts (</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    video_id text,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    time_bucket timestamp,  -- Hourly buckets</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    window_type text,       -- &#x27;1h&#x27;, &#x27;24h&#x27;, &#x27;7d&#x27;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    region text,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    category text,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    view_count bigint,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    PRIMARY KEY ((video_id, window_type), time_bucket, region, category)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">) WITH CLUSTERING ORDER BY (time_bucket DESC);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">CREATE TABLE top_k_snapshots (</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    window_type text,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    time_bucket timestamp,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    region text,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    category text,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    ranking list&lt;frozen&lt;video_rank&gt;&gt;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    PRIMARY KEY ((window_type, region, category), time_bucket)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">) WITH CLUSTERING ORDER BY (time_bucket DESC);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">-- Custom type</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">CREATE TYPE video_rank (</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    video_id text,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    view_count bigint,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    rank int</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="8-system-architecture-patterns">8. System Architecture Patterns<a href="#8-system-architecture-patterns" class="hash-link" aria-label="Direct link to 8. System Architecture Patterns" title="Direct link to 8. System Architecture Patterns">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="81-lambda-architecture-pattern">8.1 Lambda Architecture Pattern<a href="#81-lambda-architecture-pattern" class="hash-link" aria-label="Direct link to 8.1 Lambda Architecture Pattern" title="Direct link to 8.1 Lambda Architecture Pattern">​</a></h3>
<!-- -->
<p><strong>Benefits:</strong></p>
<ul>
<li>Speed layer: Low latency, approximate results</li>
<li>Batch layer: High accuracy, eventual consistency</li>
<li>Serving layer: Merges both for best of both worlds</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="82-kappa-architecture-pattern-simplified">8.2 Kappa Architecture Pattern (Simplified)<a href="#82-kappa-architecture-pattern-simplified" class="hash-link" aria-label="Direct link to 8.2 Kappa Architecture Pattern (Simplified)" title="Direct link to 8.2 Kappa Architecture Pattern (Simplified)">​</a></h3>
<!-- -->
<p><strong>Benefits:</strong></p>
<ul>
<li>Simpler architecture</li>
<li>Single processing pipeline</li>
<li>Reprocess by replaying Kafka</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="9-optimizations--trade-offs">9. Optimizations &amp; Trade-offs<a href="#9-optimizations--trade-offs" class="hash-link" aria-label="Direct link to 9. Optimizations &amp; Trade-offs" title="Direct link to 9. Optimizations &amp; Trade-offs">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="91-partitioning-strategy">9.1 Partitioning Strategy<a href="#91-partitioning-strategy" class="hash-link" aria-label="Direct link to 9.1 Partitioning Strategy" title="Direct link to 9.1 Partitioning Strategy">​</a></h3>
<!-- -->
<p><strong>Partitioning by video_id ensures:</strong></p>
<ul>
<li>All views for same video go to same partition</li>
<li>Enables local Count-Min Sketch per partition</li>
<li>Parallel processing across partitions</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="92-hierarchical-aggregation">9.2 Hierarchical Aggregation<a href="#92-hierarchical-aggregation" class="hash-link" aria-label="Direct link to 9.2 Hierarchical Aggregation" title="Direct link to 9.2 Hierarchical Aggregation">​</a></h3>
<!-- -->
<p><strong>Benefits:</strong></p>
<ul>
<li>Reduces network traffic</li>
<li>Pre-aggregation at edge</li>
<li>Faster global Top-K computation</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="93-sampling-techniques">9.3 Sampling Techniques<a href="#93-sampling-techniques" class="hash-link" aria-label="Direct link to 9.3 Sampling Techniques" title="Direct link to 9.3 Sampling Techniques">​</a></h3>
<p>For extremely high traffic videos, use sampling:</p>
<div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token maybe-class-name">If</span><span class="token plain"> view_count </span><span class="token operator">&gt;</span><span class="token plain"> threshold</span><span class="token operator">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    sample_rate </span><span class="token operator">=</span><span class="token plain"> base_rate </span><span class="token operator">/</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">view_count </span><span class="token operator">/</span><span class="token plain"> threshold</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword control-flow" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">random</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token operator">&lt;</span><span class="token plain"> sample_rate</span><span class="token operator">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token function" style="color:rgb(80, 250, 123)">process_event</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        weight </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">1</span><span class="token plain"> </span><span class="token operator">/</span><span class="token plain"> sample_rate</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="10-handling-edge-cases">10. Handling Edge Cases<a href="#10-handling-edge-cases" class="hash-link" aria-label="Direct link to 10. Handling Edge Cases" title="Direct link to 10. Handling Edge Cases">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="101-viral-video-spike">10.1 Viral Video Spike<a href="#101-viral-video-spike" class="hash-link" aria-label="Direct link to 10.1 Viral Video Spike" title="Direct link to 10.1 Viral Video Spike">​</a></h3>
<!-- -->
<p><strong>Detection:</strong></p>
<ul>
<li>Monitor rate of change in view counts</li>
<li>Alert when growth &gt; 500% in 15 minutes</li>
<li>Auto-scale processing capacity</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="102-bot-detection--fraud-prevention">10.2 Bot Detection &amp; Fraud Prevention<a href="#102-bot-detection--fraud-prevention" class="hash-link" aria-label="Direct link to 10.2 Bot Detection &amp; Fraud Prevention" title="Direct link to 10.2 Bot Detection &amp; Fraud Prevention">​</a></h3>
<!-- -->
<p><strong>Fraud Detection Rules:</strong></p>
<ul>
<li>IP-based rate limiting (max N views/minute)</li>
<li>User session validation</li>
<li>Device fingerprinting</li>
<li>ML-based bot detection</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="103-late-arriving-events">10.3 Late Arriving Events<a href="#103-late-arriving-events" class="hash-link" aria-label="Direct link to 10.3 Late Arriving Events" title="Direct link to 10.3 Late Arriving Events">​</a></h3>
<!-- -->
<p><strong>Watermark Strategy:</strong></p>
<div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token maybe-class-name">Watermark</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token maybe-class-name">Max_Event_Time</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain"> </span><span class="token maybe-class-name">Allowed_Lateness</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token maybe-class-name">Allowed_Lateness</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">15</span><span class="token plain"> minutes</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="11-monitoring--observability">11. Monitoring &amp; Observability<a href="#11-monitoring--observability" class="hash-link" aria-label="Direct link to 11. Monitoring &amp; Observability" title="Direct link to 11. Monitoring &amp; Observability">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="key-metrics">Key Metrics<a href="#key-metrics" class="hash-link" aria-label="Direct link to Key Metrics" title="Direct link to Key Metrics">​</a></h3>
<!-- -->
<p><strong>Alerting Rules:</strong></p>
<ul>
<li>Processing lag &gt; 10 seconds</li>
<li>Error rate &gt; 0.1%</li>
<li>Redis hit rate &lt; 95%</li>
<li>Query latency p99 &gt; 100ms</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="12-api-design">12. API Design<a href="#12-api-design" class="hash-link" aria-label="Direct link to 12. API Design" title="Direct link to 12. API Design">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="rest-api-endpoints">REST API Endpoints<a href="#rest-api-endpoints" class="hash-link" aria-label="Direct link to REST API Endpoints" title="Direct link to REST API Endpoints">​</a></h3>
<div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token constant" style="color:rgb(189, 147, 249)">GET</span><span class="token plain"> </span><span class="token operator">/</span><span class="token plain">api</span><span class="token operator">/</span><span class="token plain">v1</span><span class="token operator">/</span><span class="token plain">videos</span><span class="token operator">/</span><span class="token plain">top</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token maybe-class-name">Query</span><span class="token plain"> </span><span class="token maybe-class-name">Parameters</span><span class="token operator">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token operator">-</span><span class="token plain"> k</span><span class="token operator">:</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">number</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token keyword module" style="color:rgb(189, 147, 249);font-style:italic">default</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">100</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token operator">-</span><span class="token plain"> </span><span class="token dom variable" style="color:rgb(189, 147, 249);font-style:italic">window</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">enum</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">1h</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> 24h</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> 7d</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> 30d</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token operator">-</span><span class="token plain"> region</span><span class="token operator">:</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">string</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token keyword module" style="color:rgb(189, 147, 249);font-style:italic">default</span><span class="token operator">:</span><span class="token plain"> global</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token operator">-</span><span class="token plain"> category</span><span class="token operator">:</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">string</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token keyword module" style="color:rgb(189, 147, 249);font-style:italic">default</span><span class="token operator">:</span><span class="token plain"> all</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token literal-property property">Response</span><span class="token operator">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token string-property property">&quot;window&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;24h&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token string-property property">&quot;region&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;US&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token string-property property">&quot;category&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;music&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token string-property property">&quot;timestamp&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;2025-10-21T10:00:00Z&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token string-property property">&quot;videos&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token string-property property">&quot;rank&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token string-property property">&quot;video_id&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;abc123&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token string-property property">&quot;title&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;Viral Song&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token string-property property">&quot;view_count&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">5000000</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token string-property property">&quot;thumbnail_url&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;...&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token string-property property">&quot;channel&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;Popular Artist&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token spread operator">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="websocket-for-real-time-updates">WebSocket for Real-time Updates<a href="#websocket-for-real-time-updates" class="hash-link" aria-label="Direct link to WebSocket for Real-time Updates" title="Direct link to WebSocket for Real-time Updates">​</a></h3>
<div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token literal-property property">ws</span><span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token plain">api</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">youtube</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">com</span><span class="token operator">/</span><span class="token plain">v1</span><span class="token operator">/</span><span class="token plain">videos</span><span class="token operator">/</span><span class="token plain">top</span><span class="token operator">/</span><span class="token plain">stream</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token maybe-class-name">Message</span><span class="token plain"> </span><span class="token maybe-class-name">Format</span><span class="token operator">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token string-property property">&quot;type&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;ranking_update&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token string-property property">&quot;window&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;1h&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token string-property property">&quot;changes&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token string-property property">&quot;video_id&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;xyz789&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string-property property">&quot;old_rank&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">5</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string-property property">&quot;new_rank&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">3</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token string-property property">&quot;video_id&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;abc123&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string-property property">&quot;old_rank&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil" style="color:rgb(189, 147, 249);font-style:italic">null</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string-property property">&quot;new_rank&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">100</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token string-property property">&quot;timestamp&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;2025-10-21T10:30:15Z&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="13-cost-optimization">13. Cost Optimization<a href="#13-cost-optimization" class="hash-link" aria-label="Direct link to 13. Cost Optimization" title="Direct link to 13. Cost Optimization">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="resource-estimates">Resource Estimates<a href="#resource-estimates" class="hash-link" aria-label="Direct link to Resource Estimates" title="Direct link to Resource Estimates">​</a></h3>
<table><thead><tr><th>Component</th><th>Specification</th><th>Monthly Cost</th></tr></thead><tbody><tr><td>Kafka Cluster</td><td>20 brokers (m5.2xlarge)</td><td>$8,000</td></tr><tr><td>Flink Cluster</td><td>50 task managers (c5.4xlarge)</td><td>$25,000</td></tr><tr><td>Redis Cluster</td><td>10 nodes (r6g.2xlarge)</td><td>$5,000</td></tr><tr><td>Cassandra</td><td>30 nodes (i3.2xlarge)</td><td>$15,000</td></tr><tr><td>Network</td><td>100 TB egress</td><td>$9,000</td></tr><tr><td><strong>Total</strong></td><td></td><td><strong>~$62,000/month</strong></td></tr></tbody></table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="cost-optimization-strategies">Cost Optimization Strategies<a href="#cost-optimization-strategies" class="hash-link" aria-label="Direct link to Cost Optimization Strategies" title="Direct link to Cost Optimization Strategies">​</a></h3>
<ol>
<li><strong>Use Count-Min Sketch</strong> instead of exact counters (1,600x memory savings)</li>
<li><strong>Tiered storage</strong>: Redis (hot) → Cassandra (warm) → S3 (cold)</li>
<li><strong>Compression</strong>: Enable Kafka message compression (60% reduction)</li>
<li><strong>Reserved instances</strong>: Save 40% on compute costs</li>
<li><strong>Data retention</strong>: Keep only 30 days in Cassandra, archive to S3</li>
</ol>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="14-generic-top-k-system-design-framework">14. Generic Top-K System Design Framework<a href="#14-generic-top-k-system-design-framework" class="hash-link" aria-label="Direct link to 14. Generic Top-K System Design Framework" title="Direct link to 14. Generic Top-K System Design Framework">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="universal-components-for-any-top-k-problem">Universal Components for Any Top-K Problem<a href="#universal-components-for-any-top-k-problem" class="hash-link" aria-label="Direct link to Universal Components for Any Top-K Problem" title="Direct link to Universal Components for Any Top-K Problem">​</a></h3>
<p>Every Top-K system (trending tweets, popular products, hot searches, etc.) shares common patterns. Here&#x27;s a reusable framework:</p>
<!-- -->
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="141-problem-categories--patterns">14.1 Problem Categories &amp; Patterns<a href="#141-problem-categories--patterns" class="hash-link" aria-label="Direct link to 14.1 Problem Categories &amp; Patterns" title="Direct link to 14.1 Problem Categories &amp; Patterns">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="category-1-heavy-hitters-most-frequent-items">Category 1: Heavy Hitters (Most Frequent Items)<a href="#category-1-heavy-hitters-most-frequent-items" class="hash-link" aria-label="Direct link to Category 1: Heavy Hitters (Most Frequent Items)" title="Direct link to Category 1: Heavy Hitters (Most Frequent Items)">​</a></h4>
<p><strong>Examples</strong>: Top products, trending hashtags, popular searches</p>
<!-- -->
<p><strong>Decision Matrix:</strong></p>
<table><thead><tr><th>Cardinality</th><th>Memory Budget</th><th>Latency</th><th>Algorithm Choice</th></tr></thead><tbody><tr><td>&lt; 100K</td><td>High</td><td>Low</td><td>HashMap + Min-Heap</td></tr><tr><td>100K-10M</td><td>Medium</td><td>Low</td><td>Count-Min Sketch + Heap</td></tr><tr><td>&gt; 10M</td><td>Low</td><td>Medium</td><td>Space-Saving + Sampling</td></tr><tr><td>Any</td><td>Very Low</td><td>Any</td><td>Lossy Counting</td></tr></tbody></table>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="category-2-time-sensitive-ranking-trending-items">Category 2: Time-Sensitive Ranking (Trending Items)<a href="#category-2-time-sensitive-ranking-trending-items" class="hash-link" aria-label="Direct link to Category 2: Time-Sensitive Ranking (Trending Items)" title="Direct link to Category 2: Time-Sensitive Ranking (Trending Items)">​</a></h4>
<p><strong>Examples</strong>: Trending topics, viral content, breaking news</p>
<p><strong>Key Challenge</strong>: Balance recency vs popularity</p>
<!-- -->
<p><strong>Exponential Decay Formula:</strong></p>
<div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token function" style="color:rgb(80, 250, 123)">score</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">t</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> count </span><span class="token operator">*</span><span class="token plain"> e</span><span class="token operator">^</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token operator">-</span><span class="token plain">λ </span><span class="token operator">*</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">current_time </span><span class="token operator">-</span><span class="token plain"> event_time</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">λ </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">decay_rate</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">e</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">g</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token number">0.0001</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:rgb(189, 147, 249);font-style:italic">for</span><span class="token plain"> hourly decay</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="category-3-multi-dimensional-top-k">Category 3: Multi-Dimensional Top-K<a href="#category-3-multi-dimensional-top-k" class="hash-link" aria-label="Direct link to Category 3: Multi-Dimensional Top-K" title="Direct link to Category 3: Multi-Dimensional Top-K">​</a></h4>
<p><strong>Examples</strong>: Top products by category, top videos by region</p>
<!-- -->
<p><strong>Storage Example:</strong></p>
<div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain"># </span><span class="token maybe-class-name">Single</span><span class="token plain"> dimension</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token literal-property property">topk</span><span class="token operator">:</span><span class="token plain">global → </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">item1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> item2</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token spread operator">...</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># </span><span class="token maybe-class-name">Multiple</span><span class="token plain"> dimensions</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token literal-property property">topk</span><span class="token operator">:</span><span class="token plain">us</span><span class="token operator">:</span><span class="token plain">electronics → </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">item3</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> item5</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token spread operator">...</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token literal-property property">topk</span><span class="token operator">:</span><span class="token plain">uk</span><span class="token operator">:</span><span class="token plain">books → </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">item7</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> item9</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token spread operator">...</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># </span><span class="token maybe-class-name">With</span><span class="token plain"> aggregation</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token literal-property property">topk</span><span class="token operator">:</span><span class="token plain">global → </span><span class="token function" style="color:rgb(80, 250, 123)">aggregate</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">all regions</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> all categories</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="142-universal-design-checklist">14.2 Universal Design Checklist<a href="#142-universal-design-checklist" class="hash-link" aria-label="Direct link to 14.2 Universal Design Checklist" title="Direct link to 14.2 Universal Design Checklist">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="phase-1-requirements-analysis">Phase 1: Requirements Analysis<a href="#phase-1-requirements-analysis" class="hash-link" aria-label="Direct link to Phase 1: Requirements Analysis" title="Direct link to Phase 1: Requirements Analysis">​</a></h4>
<div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">✓ </span><span class="token maybe-class-name">Define</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;Top-K&quot;</span><span class="token plain"> clearly</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  □ </span><span class="token maybe-class-name">By</span><span class="token plain"> count</span><span class="token operator">/</span><span class="token plain">frequency</span><span class="token operator">?</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  □ </span><span class="token maybe-class-name">By</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">score</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">weighted</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token operator">?</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  □ </span><span class="token maybe-class-name">By</span><span class="token plain"> revenue</span><span class="token operator">/</span><span class="token plain">value</span><span class="token operator">?</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  □ </span><span class="token maybe-class-name">By</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">engagement</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">clicks</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> time</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token operator">?</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">✓ </span><span class="token maybe-class-name">Cardinality</span><span class="token plain"> estimation</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  □ </span><span class="token maybe-class-name">Total</span><span class="token plain"> unique items</span><span class="token operator">:</span><span class="token plain"> ___</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  □ </span><span class="token maybe-class-name">Active</span><span class="token plain"> items per </span><span class="token dom variable" style="color:rgb(189, 147, 249);font-style:italic">window</span><span class="token operator">:</span><span class="token plain"> ___</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  □ </span><span class="token maybe-class-name">Expected</span><span class="token plain"> growth rate</span><span class="token operator">:</span><span class="token plain"> ___</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">✓ </span><span class="token maybe-class-name">Query</span><span class="token plain"> patterns</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  □ </span><span class="token maybe-class-name">Global</span><span class="token plain"> </span><span class="token maybe-class-name">Top</span><span class="token operator">-</span><span class="token constant" style="color:rgb(189, 147, 249)">K</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  □ </span><span class="token maybe-class-name">Regional</span><span class="token operator">/</span><span class="token maybe-class-name">Segmented</span><span class="token plain"> </span><span class="token maybe-class-name">Top</span><span class="token operator">-</span><span class="token constant" style="color:rgb(189, 147, 249)">K</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  □ </span><span class="token maybe-class-name">Time</span><span class="token operator">-</span><span class="token plain">windowed </span><span class="token maybe-class-name">Top</span><span class="token operator">-</span><span class="token constant" style="color:rgb(189, 147, 249)">K</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  □ </span><span class="token maybe-class-name">Real</span><span class="token operator">-</span><span class="token plain">time updates needed</span><span class="token operator">?</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">✓ </span><span class="token maybe-class-name">Accuracy</span><span class="token plain"> requirements</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  □ </span><span class="token maybe-class-name">Exact</span><span class="token plain"> required</span><span class="token operator">?</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">±</span><span class="token number">0</span><span class="token operator">%</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  □ </span><span class="token maybe-class-name">High</span><span class="token plain"> accuracy</span><span class="token operator">?</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">±</span><span class="token number">1</span><span class="token operator">-</span><span class="token number">2</span><span class="token operator">%</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  □ </span><span class="token maybe-class-name">Approximate</span><span class="token plain"> </span><span class="token constant" style="color:rgb(189, 147, 249)">OK</span><span class="token operator">?</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">±</span><span class="token number">5</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">%</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">✓ </span><span class="token maybe-class-name">Latency</span><span class="token plain"> requirements</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  □ </span><span class="token maybe-class-name">Real</span><span class="token operator">-</span><span class="token function" style="color:rgb(80, 250, 123)">time</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token operator">&lt;</span><span class="token plain">1s</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  □ </span><span class="token maybe-class-name">Near</span><span class="token plain"> real</span><span class="token operator">-</span><span class="token function" style="color:rgb(80, 250, 123)">time</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token number">1</span><span class="token operator">-</span><span class="token plain">10s</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  □ </span><span class="token function maybe-class-name" style="color:rgb(80, 250, 123)">Batch</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">minutes</span><span class="token operator">/</span><span class="token plain">hours</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="phase-2-algorithm-selection">Phase 2: Algorithm Selection<a href="#phase-2-algorithm-selection" class="hash-link" aria-label="Direct link to Phase 2: Algorithm Selection" title="Direct link to Phase 2: Algorithm Selection">​</a></h4>
<!-- -->
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="phase-3-data-structure-selection">Phase 3: Data Structure Selection<a href="#phase-3-data-structure-selection" class="hash-link" aria-label="Direct link to Phase 3: Data Structure Selection" title="Direct link to Phase 3: Data Structure Selection">​</a></h4>
<p><strong>Comparison Table:</strong></p>
<table><thead><tr><th>Data Structure</th><th>Space</th><th>Update</th><th>Query</th><th>Use Case</th></tr></thead><tbody><tr><td><strong>HashMap + Heap</strong></td><td>O(N)</td><td>O(log K)</td><td>O(1)</td><td>Small N, exact counts</td></tr><tr><td><strong>Count-Min Sketch</strong></td><td>O(w*d)</td><td>O(d)</td><td>O(d)</td><td>Large N, approximate</td></tr><tr><td><strong>Count Sketch</strong></td><td>O(w*d)</td><td>O(d)</td><td>O(d)</td><td>Better accuracy than CMS</td></tr><tr><td><strong>Space-Saving</strong></td><td>O(K)</td><td>O(1)</td><td>O(K)</td><td>Memory-critical, Top-K only</td></tr><tr><td><strong>Lossy Counting</strong></td><td>O(1/ε)</td><td>O(1)</td><td>O(1/ε)</td><td>Bounded error, simple</td></tr><tr><td><strong>HyperLogLog</strong></td><td>O(m)</td><td>O(1)</td><td>O(1)</td><td>Cardinality only</td></tr><tr><td><strong>Bloom Filter</strong></td><td>O(m)</td><td>O(k)</td><td>O(k)</td><td>Membership, not counting</td></tr></tbody></table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="143-common-patterns--anti-patterns">14.3 Common Patterns &amp; Anti-Patterns<a href="#143-common-patterns--anti-patterns" class="hash-link" aria-label="Direct link to 14.3 Common Patterns &amp; Anti-Patterns" title="Direct link to 14.3 Common Patterns &amp; Anti-Patterns">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="-best-practices">✅ Best Practices<a href="#-best-practices" class="hash-link" aria-label="Direct link to ✅ Best Practices" title="Direct link to ✅ Best Practices">​</a></h4>
<p><strong>1. Layered Aggregation</strong></p>
<!-- -->
<p><strong>Benefits:</strong></p>
<ul>
<li>Reduces network traffic by 10-100x</li>
<li>Enables parallel processing</li>
<li>Natural sharding strategy</li>
</ul>
<p><strong>2. Hybrid Counting Strategy</strong></p>
<div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token maybe-class-name">If</span><span class="token plain"> item_count </span><span class="token operator">&lt;</span><span class="token plain"> threshold</span><span class="token operator">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token maybe-class-name">Use</span><span class="token plain"> exact </span><span class="token function" style="color:rgb(80, 250, 123)">counting</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token maybe-class-name">HashMap</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token literal-property property">Else</span><span class="token operator">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token maybe-class-name">Use</span><span class="token plain"> </span><span class="token maybe-class-name">Count</span><span class="token operator">-</span><span class="token maybe-class-name">Min</span><span class="token plain"> </span><span class="token maybe-class-name">Sketch</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>3. Progressive Accuracy</strong></p>
<div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token maybe-class-name">Top</span><span class="token plain"> </span><span class="token number">10</span><span class="token operator">:</span><span class="token plain">    </span><span class="token function maybe-class-name" style="color:rgb(80, 250, 123)">Exact</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token number">99.9</span><span class="token operator">%</span><span class="token plain"> accuracy</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token maybe-class-name">Top</span><span class="token plain"> </span><span class="token number">11</span><span class="token operator">-</span><span class="token number">50</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">High</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">precision</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token number">98</span><span class="token operator">%</span><span class="token plain"> accuracy</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token maybe-class-name">Top</span><span class="token plain"> </span><span class="token number">51</span><span class="token operator">-</span><span class="token number">100</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">Good</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">enough</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token number">95</span><span class="token operator">%</span><span class="token plain"> accuracy</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token maybe-class-name">Top</span><span class="token plain"> </span><span class="token number">100</span><span class="token operator">+</span><span class="token operator">:</span><span class="token plain">  </span><span class="token function maybe-class-name" style="color:rgb(80, 250, 123)">Approximate</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token number">90</span><span class="token operator">%</span><span class="token plain"> accuracy</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>4. Time-Based Partitioning</strong></p>
<div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token maybe-class-name">Partition</span><span class="token plain"> by hour</span><span class="token operator">/</span><span class="token plain">day</span><span class="token operator">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token literal-property property">topk</span><span class="token operator">:</span><span class="token number">2025</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">21</span><span class="token operator">-</span><span class="token number">10</span><span class="token plain"> → </span><span class="token maybe-class-name">Hour</span><span class="token plain"> </span><span class="token dom variable" style="color:rgb(189, 147, 249);font-style:italic">window</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token literal-property property">topk</span><span class="token operator">:</span><span class="token number">2025</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">21</span><span class="token plain"> → </span><span class="token maybe-class-name">Day</span><span class="token plain"> </span><span class="token dom variable" style="color:rgb(189, 147, 249);font-style:italic">window</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token literal-property property">topk</span><span class="token operator">:</span><span class="token number">2025</span><span class="token operator">-</span><span class="token number">10</span><span class="token plain"> → </span><span class="token maybe-class-name">Month</span><span class="token plain"> </span><span class="token dom variable" style="color:rgb(189, 147, 249);font-style:italic">window</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token literal-property property">Enable</span><span class="token operator">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token operator">-</span><span class="token plain"> </span><span class="token maybe-class-name">Parallel</span><span class="token plain"> processing</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token operator">-</span><span class="token plain"> </span><span class="token maybe-class-name">Easy</span><span class="token plain"> </span><span class="token constant" style="color:rgb(189, 147, 249)">TTL</span><span class="token operator">/</span><span class="token plain">expiration</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token operator">-</span><span class="token plain"> </span><span class="token maybe-class-name">Historical</span><span class="token plain"> queries</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="-anti-patterns-to-avoid">❌ Anti-Patterns to Avoid<a href="#-anti-patterns-to-avoid" class="hash-link" aria-label="Direct link to ❌ Anti-Patterns to Avoid" title="Direct link to ❌ Anti-Patterns to Avoid">​</a></h4>
<p><strong>1. The &quot;Everything Exact&quot; Trap</strong></p>
<div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">❌ </span><span class="token maybe-class-name">Storing</span><span class="token plain"> exact counts </span><span class="token keyword control-flow" style="color:rgb(189, 147, 249);font-style:italic">for</span><span class="token plain"> billions </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">of</span><span class="token plain"> items</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">✅ </span><span class="token maybe-class-name">Use</span><span class="token plain"> probabilistic </span><span class="token keyword control-flow" style="color:rgb(189, 147, 249);font-style:italic">for</span><span class="token plain"> tail</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> exact </span><span class="token keyword control-flow" style="color:rgb(189, 147, 249);font-style:italic">for</span><span class="token plain"> head</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>2. The &quot;Single Point of Aggregation&quot;</strong></p>
<div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">❌ </span><span class="token maybe-class-name">One</span><span class="token plain"> server aggregates all events</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">✅ </span><span class="token maybe-class-name">Hierarchical</span><span class="token plain"> aggregation across multiple layers</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>3. The &quot;No Time Windows&quot;</strong></p>
<div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">❌ </span><span class="token maybe-class-name">Only</span><span class="token plain"> all</span><span class="token operator">-</span><span class="token plain">time </span><span class="token maybe-class-name">Top</span><span class="token operator">-</span><span class="token constant" style="color:rgb(189, 147, 249)">K</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">✅ </span><span class="token maybe-class-name">Multiple</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">windows</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">1h</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> 24h</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> 7d</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> 30d</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> all</span><span class="token operator">-</span><span class="token plain">time</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>4. The &quot;Synchronous Updates&quot;</strong></p>
<div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">❌ </span><span class="token maybe-class-name">Update</span><span class="token plain"> </span><span class="token maybe-class-name">Top</span><span class="token operator">-</span><span class="token constant" style="color:rgb(189, 147, 249)">K</span><span class="token plain"> on every single event</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">✅ </span><span class="token maybe-class-name">Batch</span><span class="token plain"> updates or micro</span><span class="token operator">-</span><span class="token function" style="color:rgb(80, 250, 123)">batches</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token number">100</span><span class="token operator">-</span><span class="token number">1000</span><span class="token plain"> events</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>5. The &quot;Ignoring Cold Start&quot;</strong></p>
<div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">❌ </span><span class="token maybe-class-name">Empty</span><span class="token plain"> </span><span class="token maybe-class-name">Top</span><span class="token operator">-</span><span class="token constant" style="color:rgb(189, 147, 249)">K</span><span class="token plain"> at system startup</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">✅ </span><span class="token maybe-class-name">Bootstrap</span><span class="token plain"> </span><span class="token keyword module" style="color:rgb(189, 147, 249);font-style:italic">from</span><span class="token plain"> historical data or defaults</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="144-scalability-patterns">14.4 Scalability Patterns<a href="#144-scalability-patterns" class="hash-link" aria-label="Direct link to 14.4 Scalability Patterns" title="Direct link to 14.4 Scalability Patterns">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="horizontal-scaling-strategy">Horizontal Scaling Strategy<a href="#horizontal-scaling-strategy" class="hash-link" aria-label="Direct link to Horizontal Scaling Strategy" title="Direct link to Horizontal Scaling Strategy">​</a></h4>
<!-- -->
<p><strong>Merge Algorithm for Distributed Top-K:</strong></p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">merge_topk_lists</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">partition_topks</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> List</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">List</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">Item</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> k</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">int</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token triple-quoted-string string" style="color:rgb(255, 121, 198)">&quot;&quot;&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token triple-quoted-string string" style="color:rgb(255, 121, 198)">    Merge Top-K from multiple partitions</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token triple-quoted-string string" style="color:rgb(255, 121, 198)">    Time: O(P * K * log K) where P = partitions</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token triple-quoted-string string" style="color:rgb(255, 121, 198)">    &quot;&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    min_heap </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># Initialize with first item from each partition</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">for</span><span class="token plain"> partition_id</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> items </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">in</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">enumerate</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">partition_topks</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> items</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            heapq</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">heappush</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">min_heap</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token operator">-</span><span class="token plain">items</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token number">0</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">count</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> partition_id</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    result </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">while</span><span class="token plain"> min_heap </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">and</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">len</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">result</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token operator">&lt;</span><span class="token plain"> k</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        neg_count</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> partition_id</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> idx </span><span class="token operator">=</span><span class="token plain"> heapq</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">heappop</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">min_heap</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        items </span><span class="token operator">=</span><span class="token plain"> partition_topks</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">partition_id</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        result</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">append</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">items</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">idx</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token comment" style="color:rgb(98, 114, 164)"># Add next item from same partition</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> idx </span><span class="token operator">+</span><span class="token plain"> </span><span class="token number">1</span><span class="token plain"> </span><span class="token operator">&lt;</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">len</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">items</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            heapq</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">heappush</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">min_heap</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token operator">-</span><span class="token plain">items</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">idx</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">count</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> partition_id</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> idx</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="token plain"> result</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="vertical-scaling-strategy">Vertical Scaling Strategy<a href="#vertical-scaling-strategy" class="hash-link" aria-label="Direct link to Vertical Scaling Strategy" title="Direct link to Vertical Scaling Strategy">​</a></h4>
<!-- -->
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="145-testing--validation">14.5 Testing &amp; Validation<a href="#145-testing--validation" class="hash-link" aria-label="Direct link to 14.5 Testing &amp; Validation" title="Direct link to 14.5 Testing &amp; Validation">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="correctness-testing">Correctness Testing<a href="#correctness-testing" class="hash-link" aria-label="Direct link to Correctness Testing" title="Direct link to Correctness Testing">​</a></h4>
<!-- -->
<p><strong>Accuracy Validation Script:</strong></p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">validate_topk_accuracy</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">exact_counts</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> approximate_topk</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> k</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token triple-quoted-string string" style="color:rgb(255, 121, 198)">&quot;&quot;&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token triple-quoted-string string" style="color:rgb(255, 121, 198)">    Validate Top-K accuracy</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token triple-quoted-string string" style="color:rgb(255, 121, 198)">    &quot;&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># Get ground truth Top-K</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    ground_truth </span><span class="token operator">=</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">sorted</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">exact_counts</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">items</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                         key</span><span class="token operator">=</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">lambda</span><span class="token plain"> x</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> x</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token number">1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                         reverse</span><span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">k</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># Calculate metrics</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    precision </span><span class="token operator">=</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">len</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token builtin" style="color:rgb(189, 147, 249)">set</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">approximate_topk</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token operator">&amp;</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">set</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">ground_truth</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token operator">/</span><span class="token plain"> k</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># Rank correlation (Kendall&#x27;s Tau)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    rank_correlation </span><span class="token operator">=</span><span class="token plain"> calculate_kendall_tau</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">ground_truth</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> approximate_topk</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># Count error</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    avg_count_error </span><span class="token operator">=</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">sum</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token builtin" style="color:rgb(189, 147, 249)">abs</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">exact_counts</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">item</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain"> approx_count</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                         </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">for</span><span class="token plain"> item</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> approx_count </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">in</span><span class="token plain"> approximate_topk</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token operator">/</span><span class="token plain"> k</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;precision&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> precision</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;rank_correlation&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> rank_correlation</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;avg_count_error&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> avg_count_error</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="146-monitoring-template">14.6 Monitoring Template<a href="#146-monitoring-template" class="hash-link" aria-label="Direct link to 14.6 Monitoring Template" title="Direct link to 14.6 Monitoring Template">​</a></h3>
<p><strong>Universal Metrics Dashboard:</strong></p>
<!-- -->
<p><strong>Alert Thresholds (Generic):</strong></p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token key atrule">alerts</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">critical</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> processing_lag </span><span class="token punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"> 60s</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> error_rate </span><span class="token punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"> 1%</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> query_latency_p99 </span><span class="token punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"> 1s</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> cache_hit_rate &lt; 90%</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">warning</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> processing_lag </span><span class="token punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"> 30s</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> error_rate </span><span class="token punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"> 0.1%</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> memory_usage </span><span class="token punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"> 80%</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> topk_accuracy &lt; 95%</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="147-configuration-template">14.7 Configuration Template<a href="#147-configuration-template" class="hash-link" aria-label="Direct link to 14.7 Configuration Template" title="Direct link to 14.7 Configuration Template">​</a></h3>
<p><strong>Reusable Configuration Pattern:</strong></p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token key atrule">top_k_config</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># Core parameters</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">k</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">100</span><span class="token plain">                          </span><span class="token comment" style="color:rgb(98, 114, 164)"># Number of top items</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">update_interval_ms</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">1000</span><span class="token plain">        </span><span class="token comment" style="color:rgb(98, 114, 164)"># How often to recompute Top-K</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># Algorithm selection</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">algorithm</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">small_scale</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;exact_heap&quot;</span><span class="token plain">     </span><span class="token comment" style="color:rgb(98, 114, 164)"># &lt; 100K items</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">medium_scale</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;count_min_sketch&quot;</span><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># 100K-10M items</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">large_scale</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;space_saving&quot;</span><span class="token plain">   </span><span class="token comment" style="color:rgb(98, 114, 164)"># &gt; 10M items</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># Count-Min Sketch parameters</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">cms</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">width</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">2048</span><span class="token plain">                   </span><span class="token comment" style="color:rgb(98, 114, 164)"># w = ceil(e / epsilon)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">depth</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">7</span><span class="token plain">                      </span><span class="token comment" style="color:rgb(98, 114, 164)"># d = ceil(ln(1 / delta))</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">epsilon</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">0.001</span><span class="token plain">                </span><span class="token comment" style="color:rgb(98, 114, 164)"># Error rate: 0.1%</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">delta</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">0.001</span><span class="token plain">                  </span><span class="token comment" style="color:rgb(98, 114, 164)"># Confidence: 99.9%</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># Time windows</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">windows</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;realtime&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">duration</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;5m&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">slide</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;1m&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;hourly&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">duration</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;1h&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">slide</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;5m&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;daily&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">duration</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;24h&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">slide</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;1h&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;weekly&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">duration</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;7d&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">slide</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;1d&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># Storage tiers</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">storage</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">hot</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">type</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;redis&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">ttl</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;1h&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">max_size</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;1GB&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">warm</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">type</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;cassandra&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">ttl</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;30d&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">cold</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">type</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;s3&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">ttl</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;365d&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># Performance tuning</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">performance</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">batch_size</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">1000</span><span class="token plain">              </span><span class="token comment" style="color:rgb(98, 114, 164)"># Events per batch</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">parallelism</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">16</span><span class="token plain">               </span><span class="token comment" style="color:rgb(98, 114, 164)"># Parallel workers</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">buffer_size</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">10000</span><span class="token plain">            </span><span class="token comment" style="color:rgb(98, 114, 164)"># Event buffer</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">checkpoint_interval</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;60s&quot;</span><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># State checkpoint</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># Scaling thresholds</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">auto_scale</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">scale_up_threshold</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">0.8</span><span class="token plain">       </span><span class="token comment" style="color:rgb(98, 114, 164)"># CPU/Memory %</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">scale_down_threshold</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">0.3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">min_instances</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">max_instances</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">20</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="148-migration-strategy">14.8 Migration Strategy<a href="#148-migration-strategy" class="hash-link" aria-label="Direct link to 14.8 Migration Strategy" title="Direct link to 14.8 Migration Strategy">​</a></h3>
<p><strong>From Exact to Approximate:</strong></p>
<!-- -->
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="149-quick-reference-problem--solution">14.9 Quick Reference: Problem → Solution<a href="#149-quick-reference-problem--solution" class="hash-link" aria-label="Direct link to 14.9 Quick Reference: Problem → Solution" title="Direct link to 14.9 Quick Reference: Problem → Solution">​</a></h3>
<table><thead><tr><th>Problem Type</th><th>Key Challenge</th><th>Recommended Approach</th></tr></thead><tbody><tr><td><strong>Trending Hashtags</strong></td><td>Time decay</td><td>Exponential decay + Count-Min Sketch</td></tr><tr><td><strong>Popular Products</strong></td><td>Multiple categories</td><td>Multi-dimensional Top-K + Redis</td></tr><tr><td><strong>Viral Videos</strong></td><td>Sudden spikes</td><td>Auto-scaling + Heavy hitter detection</td></tr><tr><td><strong>Hot Searches</strong></td><td>Short-lived trends</td><td>Sliding windows + Space-Saving</td></tr><tr><td><strong>Top Sellers</strong></td><td>Exact revenue</td><td>Exact counting + Sampling for tail</td></tr><tr><td><strong>Frequent Buyers</strong></td><td>User segmentation</td><td>Hierarchical Top-K per segment</td></tr><tr><td><strong>Popular Articles</strong></td><td>Time + engagement</td><td>Composite score + Min-Heap</td></tr><tr><td><strong>Trending Topics</strong></td><td>Multi-region</td><td>Distributed Top-K + Merge</td></tr></tbody></table>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="15-summary--trade-offs">15. Summary &amp; Trade-offs<a href="#15-summary--trade-offs" class="hash-link" aria-label="Direct link to 15. Summary &amp; Trade-offs" title="Direct link to 15. Summary &amp; Trade-offs">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="design-decisions">Design Decisions<a href="#design-decisions" class="hash-link" aria-label="Direct link to Design Decisions" title="Direct link to Design Decisions">​</a></h3>
<table><thead><tr><th>Aspect</th><th>Choice</th><th>Alternative</th><th>Trade-off</th></tr></thead><tbody><tr><td><strong>Counting</strong></td><td>Count-Min Sketch</td><td>Exact counters</td><td>Accuracy vs Memory</td></tr><tr><td><strong>Top-K</strong></td><td>Min-Heap + CMS</td><td>Space-Saving</td><td>Simplicity vs Accuracy</td></tr><tr><td><strong>Stream Processing</strong></td><td>Apache Flink</td><td>Spark Streaming</td><td>Latency vs Maturity</td></tr><tr><td><strong>Cache</strong></td><td>Redis Sorted Sets</td><td>Memcached</td><td>Features vs Speed</td></tr><tr><td><strong>Storage</strong></td><td>Cassandra</td><td>PostgreSQL</td><td>Scale vs Simplicity</td></tr><tr><td><strong>Architecture</strong></td><td>Kappa</td><td>Lambda</td><td>Simplicity vs Accuracy</td></tr></tbody></table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="key-takeaways">Key Takeaways<a href="#key-takeaways" class="hash-link" aria-label="Direct link to Key Takeaways" title="Direct link to Key Takeaways">​</a></h3>
<ol>
<li><strong>Probabilistic data structures</strong> (Count-Min Sketch) enable massive scale</li>
<li><strong>Stream processing</strong> provides real-time updates with low latency</li>
<li><strong>Time windows</strong> support different use cases (trending vs popular)</li>
<li><strong>Partitioning by video_id</strong> enables parallel processing</li>
<li><strong>Hierarchical aggregation</strong> reduces network traffic</li>
<li><strong>Multi-layer caching</strong> (Redis + Cassandra + S3) optimizes cost</li>
<li><strong>Accuracy trade-off</strong> (90-95%) acceptable for this use case</li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="scalability">Scalability<a href="#scalability" class="hash-link" aria-label="Direct link to Scalability" title="Direct link to Scalability">​</a></h3>
<p>The system can scale to:</p>
<ul>
<li>✅ 500,000+ views/second</li>
<li>✅ 5+ billion videos</li>
<li>✅ Sub-second query latency</li>
<li>✅ 99.99% availability</li>
<li>✅ Global distribution across regions</li>
</ul>
<hr>
<p><strong>Total System Capacity:</strong></p>
<ul>
<li><strong>Throughput</strong>: 500K events/sec</li>
<li><strong>Latency</strong>: <code>&lt;1</code> second end-to-end</li>
<li><strong>Accuracy</strong>: 90-95% (configurable via CMS parameters)</li>
<li><strong>Storage</strong>: ~10 MB per Top-K (Count-Min Sketch)</li>
<li><strong>Scale</strong>: Horizontally scalable to billions of videos</li>
</ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/carefree-ladka/docs/High Level Designs/System Design: Top-K YouTube Videos.mdx" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/High Level Designs/System Design: Spotify Top-K Songs Tracker"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">System Design: Spotify Top-K Songs Tracker</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/High Level Designs/Video Streaming"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Video Streaming at Scale 🎥</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#1-problem-understanding--requirements" class="table-of-contents__link toc-highlight">1. Problem Understanding &amp; Requirements</a><ul><li><a href="#functional-requirements" class="table-of-contents__link toc-highlight">Functional Requirements</a></li><li><a href="#non-functional-requirements" class="table-of-contents__link toc-highlight">Non-Functional Requirements</a></li><li><a href="#scale-estimation" class="table-of-contents__link toc-highlight">Scale Estimation</a></li></ul></li><li><a href="#2-high-level-architecture" class="table-of-contents__link toc-highlight">2. High-Level Architecture</a></li><li><a href="#3-core-components-deep-dive" class="table-of-contents__link toc-highlight">3. Core Components Deep Dive</a><ul><li><a href="#31-data-model" class="table-of-contents__link toc-highlight">3.1 Data Model</a></li><li><a href="#32-stream-processing-pipeline" class="table-of-contents__link toc-highlight">3.2 Stream Processing Pipeline</a></li></ul></li><li><a href="#4-count-min-sketch-implementation" class="table-of-contents__link toc-highlight">4. Count-Min Sketch Implementation</a><ul><li><a href="#what-is-count-min-sketch" class="table-of-contents__link toc-highlight">What is Count-Min Sketch?</a></li><li><a href="#count-min-sketch-algorithm" class="table-of-contents__link toc-highlight">Count-Min Sketch Algorithm</a></li><li><a href="#why-count-min-sketch-for-youtube" class="table-of-contents__link toc-highlight">Why Count-Min Sketch for YouTube?</a></li></ul></li><li><a href="#5-top-k-algorithm-design" class="table-of-contents__link toc-highlight">5. Top-K Algorithm Design</a><ul><li><a href="#heap-based-approach" class="table-of-contents__link toc-highlight">Heap-Based Approach</a></li><li><a href="#space-saving-algorithm-alternative" class="table-of-contents__link toc-highlight">Space-Saving Algorithm (Alternative)</a></li></ul></li><li><a href="#6-time-window-processing" class="table-of-contents__link toc-highlight">6. Time Window Processing</a><ul><li><a href="#window-types" class="table-of-contents__link toc-highlight">Window Types</a></li><li><a href="#multi-window-architecture" class="table-of-contents__link toc-highlight">Multi-Window Architecture</a></li></ul></li><li><a href="#7-database-design" class="table-of-contents__link toc-highlight">7. Database Design</a><ul><li><a href="#redis-schema-hot-data---top-k-cache" class="table-of-contents__link toc-highlight">Redis Schema (Hot Data - Top-K Cache)</a></li><li><a href="#cassandra-schema-cold-data---historical" class="table-of-contents__link toc-highlight">Cassandra Schema (Cold Data - Historical)</a></li></ul></li><li><a href="#8-system-architecture-patterns" class="table-of-contents__link toc-highlight">8. System Architecture Patterns</a><ul><li><a href="#81-lambda-architecture-pattern" class="table-of-contents__link toc-highlight">8.1 Lambda Architecture Pattern</a></li><li><a href="#82-kappa-architecture-pattern-simplified" class="table-of-contents__link toc-highlight">8.2 Kappa Architecture Pattern (Simplified)</a></li></ul></li><li><a href="#9-optimizations--trade-offs" class="table-of-contents__link toc-highlight">9. Optimizations &amp; Trade-offs</a><ul><li><a href="#91-partitioning-strategy" class="table-of-contents__link toc-highlight">9.1 Partitioning Strategy</a></li><li><a href="#92-hierarchical-aggregation" class="table-of-contents__link toc-highlight">9.2 Hierarchical Aggregation</a></li><li><a href="#93-sampling-techniques" class="table-of-contents__link toc-highlight">9.3 Sampling Techniques</a></li></ul></li><li><a href="#10-handling-edge-cases" class="table-of-contents__link toc-highlight">10. Handling Edge Cases</a><ul><li><a href="#101-viral-video-spike" class="table-of-contents__link toc-highlight">10.1 Viral Video Spike</a></li><li><a href="#102-bot-detection--fraud-prevention" class="table-of-contents__link toc-highlight">10.2 Bot Detection &amp; Fraud Prevention</a></li><li><a href="#103-late-arriving-events" class="table-of-contents__link toc-highlight">10.3 Late Arriving Events</a></li></ul></li><li><a href="#11-monitoring--observability" class="table-of-contents__link toc-highlight">11. Monitoring &amp; Observability</a><ul><li><a href="#key-metrics" class="table-of-contents__link toc-highlight">Key Metrics</a></li></ul></li><li><a href="#12-api-design" class="table-of-contents__link toc-highlight">12. API Design</a><ul><li><a href="#rest-api-endpoints" class="table-of-contents__link toc-highlight">REST API Endpoints</a></li><li><a href="#websocket-for-real-time-updates" class="table-of-contents__link toc-highlight">WebSocket for Real-time Updates</a></li></ul></li><li><a href="#13-cost-optimization" class="table-of-contents__link toc-highlight">13. Cost Optimization</a><ul><li><a href="#resource-estimates" class="table-of-contents__link toc-highlight">Resource Estimates</a></li><li><a href="#cost-optimization-strategies" class="table-of-contents__link toc-highlight">Cost Optimization Strategies</a></li></ul></li><li><a href="#14-generic-top-k-system-design-framework" class="table-of-contents__link toc-highlight">14. Generic Top-K System Design Framework</a><ul><li><a href="#universal-components-for-any-top-k-problem" class="table-of-contents__link toc-highlight">Universal Components for Any Top-K Problem</a></li><li><a href="#141-problem-categories--patterns" class="table-of-contents__link toc-highlight">14.1 Problem Categories &amp; Patterns</a></li><li><a href="#142-universal-design-checklist" class="table-of-contents__link toc-highlight">14.2 Universal Design Checklist</a></li><li><a href="#143-common-patterns--anti-patterns" class="table-of-contents__link toc-highlight">14.3 Common Patterns &amp; Anti-Patterns</a></li><li><a href="#144-scalability-patterns" class="table-of-contents__link toc-highlight">14.4 Scalability Patterns</a></li><li><a href="#145-testing--validation" class="table-of-contents__link toc-highlight">14.5 Testing &amp; Validation</a></li><li><a href="#146-monitoring-template" class="table-of-contents__link toc-highlight">14.6 Monitoring Template</a></li><li><a href="#147-configuration-template" class="table-of-contents__link toc-highlight">14.7 Configuration Template</a></li><li><a href="#148-migration-strategy" class="table-of-contents__link toc-highlight">14.8 Migration Strategy</a></li><li><a href="#149-quick-reference-problem--solution" class="table-of-contents__link toc-highlight">14.9 Quick Reference: Problem → Solution</a></li></ul></li><li><a href="#15-summary--trade-offs" class="table-of-contents__link toc-highlight">15. Summary &amp; Trade-offs</a><ul><li><a href="#design-decisions" class="table-of-contents__link toc-highlight">Design Decisions</a></li><li><a href="#key-takeaways" class="table-of-contents__link toc-highlight">Key Takeaways</a></li><li><a href="#scalability" class="table-of-contents__link toc-highlight">Scalability</a></li></ul></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/intro">Getting Started</a></li><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a class="footer__link-item" href="/interviews">Interview Experiences</a></li></ul></div><div class="col footer__col"><div class="footer__title">Connect</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://www.linkedin.com/in/kumpawan/" target="_blank" rel="noopener noreferrer" class="footer__link-item">LinkedIn<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/carefree-ladka" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.instagram.com/carefree_ladka/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Instagram<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://leetcode.com/u/Asyncy99/" target="_blank" rel="noopener noreferrer" class="footer__link-item">LeetCode<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 DevEnigma · Built with Kadak Chai ☕</div></div></div></footer></div>
</body>
</html>